##### Changed from Vanilla: faith_conversion.0004 Removed vanilla change gov effect
##### Changed from Vanilla: faith_conversion.0001 Keep large minority of old faith in county

namespace = faith_conversion




# Fired when you convert to a new faith. Convert capital county.
faith_conversion.0001 = {
	hidden = yes

	immediate = {
		if = {
			limit = {
				primary_title.tier > tier_barony
				exists = capital_county
				capital_county.faith = scope:old_faith
			}
			capital_county = {
				set_county_faith = root.faith
			}
			##### Changed from Vanilla vvvvv
			add_faith_minority_effect = {
				COUNTY = root.capital_county
				FAITH = scope:old_faith
				SIZE = large
			}
			##### Changed from Vanilla ^^^^^
		}
	}
}

# Fired when you convert to a new faith. Remove obsolete character modifiers.
faith_conversion.0002 = {
	hidden = yes

	immediate = {
		if = {
			limit = {
				NOT = { faith.religion = scope:old_faith.religion }
			}
			remove_trait = pilgrim
		}
		remove_trait = heresiarch
		remove_trait = excommunicated
		remove_character_modifier = recent_excommunication
		remove_character_modifier = excommunication_recently_lifted
		remove_character_modifier = vow_of_poverty_modifier
		remove_character_modifier = temporal_condemnation_modifier
		remove_character_modifier = ultimate_blasphemer_modifier
		remove_character_modifier = defiant_high_king_conversion_boost_modifier
		remove_character_modifier = defiant_high_queen_conversion_boost_modifier
		remove_character_modifier = fp1_jomsvikings_caused_faith_crisis_modifier
		remove_character_modifier = fp2_opportunistic_schismatic_modifier
		remove_character_modifier = fp2_friend_of_the_old_ways_modifier
		remove_character_modifier = bp2_yearly_0641_hof_modifier
		remove_character_modifier = bp2_yearly_0641_realm_priest_modifier
		remove_character_modifier = next_free_ho_hire_modifier
		# If you championed the old ways but then reform regardless, get booted down to friend.
		if = {
			limit = {
				faith.religion = scope:old_faith.religion
				has_character_modifier = fp2_champion_of_the_old_ways_modifier
			}
			remove_character_modifier = fp2_champion_of_the_old_ways_modifier
			add_character_modifier = fp2_friend_of_the_old_ways_modifier
		}
		else = { remove_character_modifier = fp2_champion_of_the_old_ways_modifier }

		# Reset patron deities.
		if = {
			limit = {
				faith = {
					OR = {
						has_doctrine = tenet_bhakti
						NOT = { religion = scope:old_faith.religion }
					}
				}
			}
			remove_character_modifier = bhakti_hinduism_ganga
			remove_character_modifier = bhakti_hinduism_saraswati
			remove_character_modifier = bhakti_hinduism_kali
			remove_character_modifier = bhakti_hinduism_kubera
			remove_character_modifier = bhakti_vaishnavism_lakishmi
			remove_character_modifier = bhakti_vaishnavism_jagganath
			remove_character_modifier = bhakti_vaishnavism_hayagriva
			remove_character_modifier = bhakti_shaivism_parvati
			remove_character_modifier = bhakti_shaivism_virabhadra
			remove_character_modifier = bhakti_shaivism_munishwarar
			remove_character_modifier = bhakti_shaivism_dakshinamoorthy
			remove_character_modifier = bhakti_smartism_ganesha
			remove_character_modifier = bhakti_smartism_vishnu
			remove_character_modifier = bhakti_smartism_shiva
			remove_character_modifier = bhakti_germanic_generic_odin
			remove_character_modifier = bhakti_germanic_not_danish_ullr
			remove_character_modifier = bhakti_germanic_danish_tyr
			remove_character_modifier = bhakti_germanic_generic_thor
			remove_character_modifier = bhakti_germanic_generic_freyr
			##### Changed from Vanilla vvvvv
			remove_character_modifier = bhakti_hinduism_murugan
			remove_character_modifier = bhakti_hinduism_varuna
			remove_character_modifier = tibet_deity_sipe_gyalmo
			remove_character_modifier = tibet_deity_shenlha_okar
			remove_character_modifier = tibet_deity_tonpa_shenrab
			remove_character_modifier = tibet_deity_yeshe_walmo
			remove_character_modifier = tibet_deity_takla_mebar
			remove_character_modifier = tibet_deity_Zhambala
			remove_character_modifier = tibet_deity_sherab_chamma
			remove_character_modifier = tibet_deity_palden_lhamo
			remove_character_modifier = tibet_deity_tara
			remove_character_modifier = tibet_deity_avalokitesvara
			remove_character_modifier = tibet_deity_yamantaka
			remove_character_modifier = tibet_deity_hevajra
			remove_character_modifier = tibet_deity_vajrayogini
			remove_character_modifier = nat_ari_thagyamin
			remove_character_modifier = nat_ari_mahagiri
			remove_character_modifier = nat_ari_hnamadawgyi
			remove_character_modifier = nat_ari_ponmagyi
			remove_character_modifier = nat_ari_sivali
			remove_character_modifier = nat_ari_shwe_nabay
			remove_character_modifier = nat_therevada_thurathadi
			remove_character_modifier = nat_therevada_lokanat
			remove_character_modifier = nat_therevada_panhtwar
			remove_character_modifier = nat_therevada_shin_upagutta
			remove_character_modifier = nat_therevada_manimekhala
			remove_character_modifier = kharis_hellenism_zeus
			remove_character_modifier = kharis_hellenism_hera
			remove_character_modifier = kharis_hellenism_athena
			remove_character_modifier = kharis_hellenism_ares
			remove_character_modifier = kharis_hellenism_demeter
			remove_character_modifier = kharis_hellenism_posidion
			remove_character_modifier = kharis_hellenism_dionysos
			remove_character_modifier = kharis_hellenism_hephestios
			remove_character_modifier = kharis_hellenism_hermes
			remove_character_modifier = kharis_hellenism_aphrodite
			remove_character_modifier = kharis_hellenism_apollon
			remove_character_modifier = kharis_hellenism_artemis
			remove_character_modifier = kharis_hellenism_herakles
			remove_character_modifier = kharis_hellenism_asklepios
			remove_character_modifier = bhakti_vohu_manah
			remove_character_modifier = bhakti_khshathra_vairya
			remove_character_modifier = bhakti_haurvatat
			remove_character_modifier = bhakti_asha_vahishta
			remove_character_modifier = bhakti_armaiti
			remove_character_modifier = bhakti_ameretat
			remove_character_modifier = patron_god_bon_war_god
			remove_character_modifier = patron_god_bon_creator_god
			remove_character_modifier = patron_god_bon_trickster_god
			remove_character_modifier = patron_god_bon_household_god
			remove_character_modifier = patron_god_bon_knowledge_god
			remove_character_modifier = patron_god_bon_health_god
			##### Changed from Vanilla ^^^^^
		}
		# No Friday prayer shenanigans unless you're involved in the Sunni caliphal drama.
		## Friday prayers would absolutely happen for others but these modifiers are currently tied heavily to the struggle.
		## Remove insubordination if you leave Islam.
		if = {
			limit = {
				NOT = { faith.religion = religion:islam_religion }
			}
			remove_character_modifier = fp3_name_read_in_friday_prayer_modifier
		}
		## Remove subordination.
		### Special use-case because you might convert faith within the various ones that consider the caliph to be their HoF, in which case it'd stay.
		if = {
			limit = {
				faith.religious_head_title ?= {
					NOT = { this = title:d_sunni }
				}
			}
			remove_character_modifier = fp3_displayed_pious_submission_to_caliph_modifier
		}
		bastard_to_wild_oat_conversion_effect = yes
	}
}


scripted_trigger faith_conversion_0003_valid_character = {
	faith = scope:old_faith
	is_alive = yes
	is_ai = yes
}

# Fired when you convert to a new faith. Convert close family.
faith_conversion.0003 = {
	hidden = yes

	immediate = {
		every_spouse = {
			limit = {
				faith_conversion_0003_valid_character = yes
				is_landed = no
			}
			set_character_faith = root.faith
		}

		every_child = {
			limit = {
				faith_conversion_0003_valid_character = yes
				target_is_liege_or_above = root #If they have travelled outside of your realm/control, they will not be converted.
				# Children are converted regardless of Landed status, assuming they are Landed within your realm.
			}
			set_character_faith_with_conversion = root.faith #Also converts their spouse, children, and parents if applicable.
		}

		if = {
			limit = {
				exists = mother
			}
			mother = {
				if = {
					limit = {
						faith_conversion_0003_valid_character = yes
						target_is_liege_or_above = root #If they have travelled outside of your realm/control, they will not be converted.
						is_landed = no #If inside your realm but landed, follow normal vassal conversion rules.
					}
					set_character_faith = root.faith
				}
			}
		}

		if = {
			limit = {
				exists = father
			}
			father = {
				if = {
					limit = {
						faith_conversion_0003_valid_character = yes
						target_is_liege_or_above = root #If they have travelled outside of your realm/control, they will not be converted.
						is_landed = no #If inside your realm but landed, follow normal vassal conversion rules.
					}
					set_character_faith = root.faith
				}
			}
		}
	}
}

##### Changed from Vanilla: faith_conversion.0004 Removed vanilla change gov effect
##### TODO (Beta): This government conversion upon lay-clergy needs to be redone for more accuracy
faith_conversion.0004 = {
	hidden = yes

	trigger = {
		government_has_flag = government_is_theocracy
		is_landed = yes
		faith = {
			has_doctrine = doctrine_theocracy_lay_clergy
		}
	}

	immediate = {
		if = {
			limit = {
				OR = {
					culture = { has_cultural_pillar = heritage_arabic }
					culture = { has_cultural_pillar = heritage_iranian }
					culture = { has_cultural_pillar = heritage_turkic }
				}
			}
			convert_realm_to_prefeudal_effect = yes
		}
		else = { convert_realm_to_prefeudal_effect = yes }
	}
}

# For softening opinion penalties, e.g., I believed in monogamous faith but was in a polygamous marriage, but now I've been converted to polygamous faith.
faith_conversion.0005 = {
	hidden = yes

	trigger = {
		any_consort = {
			count >= 1
		}
	}

	immediate = {
		every_consort = {
			save_scope_as = this_consort
			root = {
				update_active_consort_opinion_effect = { PARTNER = scope:this_consort }
			}
		}
	}
}

faith_conversion.1001 = {
	type = character_event
	title = faith_conversion.1001.t
	desc = {
		desc = faith_conversion.1001.start
		first_valid = {
			triggered_desc = {
				trigger = {
					has_trait = zealous
					faith = { has_doctrine = tenet_carnal_exaltation }
					is_male = yes
				}
				desc = faith_conversion.1001.desc.zealous.carnal_male
			}
			triggered_desc = {
				trigger = {
					has_trait = zealous
					faith = { has_doctrine = tenet_carnal_exaltation }
					is_female = yes
				}
				desc = faith_conversion.1001.desc.zealous.carnal_female
			}
			triggered_desc = {
				trigger = { has_trait = zealous }
				desc = faith_conversion.1001.desc.zealous
			}
			triggered_desc = {
				trigger = { has_trait = cynical }
				desc = faith_conversion.1001.desc.cynical
			}
			triggered_desc = {
				trigger = { faith = { has_doctrine_parameter = reincarnation_events_active } }
				desc = faith_conversion.1001.desc.reincarnation
			}
			triggered_desc = {
				trigger = { has_trait = compassionate }
				desc = faith_conversion.1001.desc.compassionate
			}
			desc = faith_conversion.1001.desc
		}
		first_valid = {
			triggered_desc = {
				trigger = {
					is_independent_ruler = no
					liege = {
						NOT = { faith = root.faith }
					} 
				}
				desc = faith_conversion.1001.end.is_vassal.convert_away
			}
			triggered_desc = {
				trigger = {
					is_independent_ruler = no
					liege = {
						faith = root.faith
					}
				}
				desc = faith_conversion.1001.end.is_vassal.convert_to
			}
			triggered_desc = {
				trigger = {
					any_vassal = {
						percent < 0.5
						faith = root.faith
					}
				}
				desc = faith_conversion.1001.end.is_top_liege.convert_away
			}
			triggered_desc = {
				trigger = {
					any_vassal = {
						percent >= 0.5
						faith = root.faith
					}
				}
				desc = faith_conversion.1001.end.is_top_liege.convert_to
			}
		}
	}
	theme = faith
	left_portrait = {
		character = scope:template_priest
		animation = personality_zealous
		triggered_outfit = {
			trigger = { scope:template_priest = { should_be_naked_trigger = yes } }
			outfit_tags = { no_clothes }
		}
		triggered_outfit = {
			trigger = { scope:template_priest = { should_be_naked_trigger = no } }
			outfit_tags = { priest_outfit }
		}
		#hide_info = yes
	}

	trigger = {
		is_ai = no # Since the event is narrative-only, there's no need to generate a temporary priest character only to kill them with no other effects for AI rulers.
	}

	immediate = {
		faith = {
			save_scope_as = new_faith
		}
		liege = {
			save_scope_as = my_liege
		}
		primary_title = {
			save_scope_as = my_title
		}
		dynasty = {
			save_scope_as = my_dynasty
		}

		create_character = {
			template = priest_character_template
			location = root.capital_province
			save_scope_as = template_priest
		}
		# If necessary, make them celibate.
		hidden_effect = {
			if = {
				limit = {
					NOT = {
						scope:new_faith = { has_doctrine_parameter = clergy_can_marry } # scoping directly to the character was firing null character errors
					}
				}
				scope:template_priest = {
					add_trait = devoted
				}
			}
		}
		
		#Dummy check to avoid errors since the flag is only checked in portrait modifiers otherwise
		if = {
			limit = {
				has_character_flag = need_priest_outfit
			}
			#Please dress properly!
		}
	}

	option = { 
		name = faith_conversion.1001.a
	}

	option = { 
		name = faith_conversion.1001.b
		# Gain scope:template priest as a courtier & earmark them for future friendship.
		add_courtier = scope:template_priest
		reverse_add_opinion = {
			target = scope:template_priest
			modifier = pious_opinion
			opinion = 50
		}
		set_relation_potential_friend = scope:template_priest
	}

	after = {
		hidden_effect = {
			if = {
				limit = {
					NOT = { this = scope:template_priest.host }
				}
				scope:template_priest = {		
					death = {
						death_reason = death_disappearance
					}
				}
			}
		}
	}
}

faith_conversion.1002 = {
	hidden = yes

	immediate = {
		# If it's desirable to delay this event (e.g., due to decision) a little, do so.
		if = {
			limit = { has_character_flag = delay_player_faith_conversion_notification_event }
			trigger_event = {
				id = faith_conversion.1001
				days = 7
			}
		}
		# Otherwise, just send it.
		else = { trigger_event = faith_conversion.1001 }
	}
}

faith_conversion.1101 = {
	hidden = yes

	immediate = {
		every_vassal = {
			limit = {
				is_ai = no
			}
			send_interface_toast = {
				title = faith_conversion.1101.toast
				left_icon = root

				show_as_tooltip = {
					root = {
						set_character_faith = faith
					}
				}
			}
		}
	}
}
