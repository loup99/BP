# scope:county
# $CULTURE$
promote_culture_minority_effect = {
	if = {
		limit = { scope:county.culture = $CULTURE$ }
		# failsafe because this should never happen
	}
	else_if = {
		limit = {
			has_variable_list = culture_minorities_small
			is_target_in_variable_list = {
				name = culture_minorities_small
				target = $CULTURE$
			}
		}
		add_to_variable_list = {
			name = culture_minorities_large
			target = $CULTURE$
		}
		remove_list_variable = {
			name = culture_minorities_small
			target = $CULTURE$
		}
	}
	else_if = {
		limit = {
			has_variable_list = culture_minorities_large
			is_target_in_variable_list = {
				name = culture_minorities_large
				target = $CULTURE$
			}
		}
		remove_list_variable = {
			name = culture_minorities_large
			target = $CULTURE$
		}
		add_to_variable_list = {
			name = culture_minorities_large
			target = scope:county.culture
		}

		set_county_culture = $CULTURE$
	}
	else = {
		add_to_variable_list = {
			name = culture_minorities_small
			target = $CULTURE$
		}
	}
}

# scope:county
# $FAITH$
promote_faith_minority_effect = {
	if = {
		limit = { scope:county.faith = $FAITH$ }
		# failsafe because this should never happen
	}
	else_if = {
		limit = {
			has_variable_list = faith_minorities_small
			is_target_in_variable_list = {
				name = faith_minorities_small
				target = $FAITH$
			}
		}
		add_to_variable_list = {
			name = faith_minorities_large
			target = $FAITH$
		}
		remove_list_variable = {
			name = faith_minorities_small
			target = $FAITH$
		}
	}
	else_if = {
		limit = {
			has_variable_list = faith_minorities_large
			is_target_in_variable_list = {
				name = faith_minorities_large
				target = $FAITH$
			}
		}
		remove_list_variable = {
			name = faith_minorities_large
			target = $FAITH$
		}
		add_to_variable_list = {
			name = faith_minorities_large
			target = scope:county.faith
		}

		set_county_faith = $FAITH$
	}
	else = {
		add_to_variable_list = {
			name = faith_minorities_small
			target = $FAITH$
		}
	}
}

demote_random_faith_minority_effect = {
	if = {
		limit = { has_variable_list = faith_minorities_small }
		every_in_list = {
			variable = faith_minorities_small
			add_to_temporary_list = potential_faiths
		}
	}
	if = {
		limit = { has_variable_list = faith_minorities_large }
		every_in_list = {
			variable = faith_minorities_large
			add_to_temporary_list = potential_faiths
		}
	}

	random_in_list = {
		list = potential_faiths
		save_scope_as = faith_to_demote
	}

	if = {
		limit = { exists = scope:faith_to_demote }

		if = {
			limit = {
				has_variable_list = faith_minorities_large
				is_target_in_variable_list = {
					name = faith_minorities_large
					target = scope:faith_to_demote
				}
			}
			remove_list_variable = {
				name = faith_minorities_large
				target = scope:faith_to_demote
			}
			add_to_variable_list = {
				name = faith_minorities_small
				target = scope:faith_to_demote
			}
		}
		else_if = {
			limit = {
				has_variable_list = faith_minorities_small
				is_target_in_variable_list = {
					name = faith_minorities_small
					target = scope:faith_to_demote
				}
			}
			remove_list_variable = {
				name = faith_minorities_small
				target = scope:faith_to_demote
			}
		}
	}
}

demote_random_culture_minority_effect = {
	if = {
		limit = { has_variable_list = culture_minorities_small }
		every_in_list = {
			variable = culture_minorities_small
			add_to_temporary_list = potential_cultures
		}
	}
	if = {
		limit = { has_variable_list = culture_minorities_large }
		every_in_list = {
			variable = culture_minorities_large
			add_to_temporary_list = potential_cultures
		}
	}

	random_in_list = {
		list = potential_cultures
		save_scope_as = culture_to_demote
	}

	if = {
		limit = { exists = scope:culture_to_demote }

		if = {
			limit = {
				has_variable_list = culture_minorities_large
				is_target_in_variable_list = {
					name = culture_minorities_large
					target = scope:culture_to_demote
				}
			}
			remove_list_variable = {
				name = culture_minorities_large
				target = scope:culture_to_demote
			}
			add_to_variable_list = {
				name = culture_minorities_small
				target = scope:culture_to_demote
			}
		}
		else_if = {
			limit = {
				has_variable_list = culture_minorities_small
				is_target_in_variable_list = {
					name = culture_minorities_small
					target = scope:culture_to_demote
				}
			}
			remove_list_variable = {
				name = culture_minorities_small
				target = scope:culture_to_demote
			}
		}
	}
}

# scope:source_county
county_to_county_culture_faith_migration_effect = {
	scope:source_county = {
		if = {
			limit = {
				any_title_to_title_neighboring_county = {
					OR = {
						NOT = { faith = scope:source_county.faith }
						NOT = { culture = scope:source_county.culture }
					}
				}
			}
			random_neighboring_county = {
				limit = {
					OR = {
						NOT = { faith = scope:source_county.faith }
						NOT = { culture = scope:source_county.culture }
					}
				}
				save_scope_as = county
				if = {
					limit = { NOT = { faith = scope:source_county.faith } }
					promote_faith_minority_effect = { FAITH = scope:source_county.faith }
				}
				if = {
					limit = { NOT = { culture = scope:source_county.culture } }
					promote_culture_minority_effect = { CULTURE = scope:source_county.culture }
				}
				notify_characters_of_culture_faith_migration_effect = yes
			}
		}
	}
}

spawn_minority_culture_in_bordering_county_effect = {
	save_scope_as = this_culture

	random_culture_county = {
		limit = {
			# Must border a culture which is not this_culture
			any_title_to_title_neighboring_county = { NOT = { this.culture = scope:this_culture } }
		}
		save_scope_as = source_county

		random_neighboring_county = {
			limit = { NOT = { this.culture = scope:this_culture } }
			save_scope_as = county

			# promote culture minority
			promote_culture_minority_effect = { CULTURE = scope:source_county.culture }
			notify_characters_of_culture_migration_effect = yes
		}
	}
}

spawn_minority_faith_in_bordering_county_effect = {
	save_scope_as = this_faith

	random_county = {
		limit = {
			faith = scope:this_faith
			# Must border a faith which is not this_faith
			any_title_to_title_neighboring_county = { NOT = { this.faith = scope:this_faith } }
		}
		save_scope_as = source_county

		random_neighboring_county = {
			limit = { NOT = { this.faith = scope:this_faith } }
			save_scope_as = county

			# promote faith minority
			promote_faith_minority_effect = { FAITH = scope:source_county.faith }
			notify_characters_of_faith_migration_effect = yes
		}
	}
}

# scope:minority_culture
# scope:source_county
minority_culture_growth_effect = {
	scope:source_county = {
		save_scope_as = county
		promote_culture_minority_effect = { CULTURE = scope:minority_culture }
	}
}

minority_culture_spread_effect = {
	scope:source_county = {
		random_neighboring_county = {
			limit = { NOT = { culture = scope:minority_culture } }
			save_scope_as = county
			promote_culture_minority_effect = { CULTURE = scope:minority_culture }
			notify_characters_of_culture_migration_effect = yes
		}
	}
}

# scope:minority_faith
# scope:source_county
minority_faith_growth_effect = {
	scope:source_county = {
		save_scope_as = county
		promote_faith_minority_effect = { FAITH = scope:minority_faith }
	}
}

minority_faith_spread_effect = {
	scope:source_county = {
		random_neighboring_county = {
			limit = { NOT = { faith = scope:minority_faith } }
			save_scope_as = county
			promote_faith_minority_effect = { FAITH = scope:minority_faith }
			notify_characters_of_faith_migration_effect = yes
		}
	}
}

# scope:source_county
# scope:county
notify_characters_of_culture_faith_migration_effect = {
	scope:source_county.holder = {
		add_to_temporary_list = characters_to_notify
		top_liege = {
			if = {
				limit = { is_ai = no }
				add_to_temporary_list = characters_to_notify
			}
			every_vassal_or_below = {
				limit = {
					is_ai = no
					any_sub_realm_county = { this = scope:source_county }
				}
				add_to_temporary_list = characters_to_notify
			}
		}
	}

	scope:county.holder = {
		add_to_temporary_list = characters_to_notify
		top_liege = {
			if = {
				limit = { is_ai = no }
				add_to_temporary_list = characters_to_notify
			}
			every_vassal_or_below = {
				limit = {
					is_ai = no
					any_sub_realm_county = { this = scope:county }
				}
				add_to_temporary_list = characters_to_notify
			}
		}
	}

	every_in_local_list = {
		list = characters_to_notify

		send_interface_toast = {
			type = event_generic_neutral
			title = minority_culture_faith_spread_title
			custom_tooltip = minority_culture_faith_spread_tt
			right_icon = scope:county
		}
	}
}

# scope:source_county
# scope:county
notify_characters_of_faith_migration_effect = {
	scope:source_county.holder = {
		add_to_temporary_list = characters_to_notify
		top_liege = {
			if = {
				limit = { is_ai = no }
				add_to_temporary_list = characters_to_notify
			}
			every_vassal_or_below = {
				limit = {
					is_ai = no
					any_sub_realm_county = { this = scope:source_county }
				}
				add_to_temporary_list = characters_to_notify
			}
		}
	}

	scope:county.holder = {
		add_to_temporary_list = characters_to_notify
		top_liege = {
			if = {
				limit = { is_ai = no }
				add_to_temporary_list = characters_to_notify
			}
			every_vassal_or_below = {
				limit = {
					is_ai = no
					any_sub_realm_county = { this = scope:county }
				}
				add_to_temporary_list = characters_to_notify
			}
		}
	}

	every_in_local_list = {
		list = characters_to_notify

		send_interface_toast = {
			type = event_generic_neutral
			title = minority_faith_spread_title
			custom_tooltip = minority_faith_spread_tt
			right_icon = scope:county
		}
	}
}

# scope:source_county
# scope:county
notify_characters_of_culture_migration_effect = {
	scope:source_county.holder = {
		add_to_temporary_list = characters_to_notify
		top_liege = {
			if = {
				limit = { is_ai = no }
				add_to_temporary_list = characters_to_notify
			}
			every_vassal_or_below = {
				limit = {
					is_ai = no
					any_sub_realm_county = { this = scope:source_county }
				}
				add_to_temporary_list = characters_to_notify
			}
		}
	}

	scope:county.holder = {
		add_to_temporary_list = characters_to_notify
		top_liege = {
			if = {
				limit = { is_ai = no }
				add_to_temporary_list = characters_to_notify
			}
			every_vassal_or_below = {
				limit = {
					is_ai = no
					any_sub_realm_county = { this = scope:county }
				}
				add_to_temporary_list = characters_to_notify
			}
		}
	}

	every_in_local_list = {
		list = characters_to_notify

		send_interface_toast = {
			type = event_generic_neutral
			title = minority_culture_spread_title
			custom_tooltip = minority_culture_spread_tt
			right_icon = scope:county
		}
	}
}

# scope:source_county
# scope:county
notify_recipient_of_culture_faith_migration_effect = {
	scope:county.holder = {
		add_to_temporary_list = characters_to_notify
		top_liege = {
			if = {
				limit = { is_ai = no }
				add_to_temporary_list = characters_to_notify
			}
			every_vassal_or_below = {
				limit = {
					is_ai = no
					any_sub_realm_county = { this = scope:county }
				}
				add_to_temporary_list = characters_to_notify
			}
		}
	}

	every_in_local_list = {
		list = characters_to_notify

		send_interface_toast = {
			type = event_generic_neutral
			title = minority_culture_faith_appearance_title
			custom_tooltip = minority_culture_faith_appearance_tt
			right_icon = scope:county
		}
	}
}

# scope:source_county
# scope:county
notify_recipient_of_faith_migration_effect = {
	scope:county.holder = {
		add_to_temporary_list = characters_to_notify
		top_liege = {
			if = {
				limit = { is_ai = no }
				add_to_temporary_list = characters_to_notify
			}
			every_vassal_or_below = {
				limit = {
					is_ai = no
					any_sub_realm_county = { this = scope:county }
				}
				add_to_temporary_list = characters_to_notify
			}
		}
	}

	every_in_local_list = {
		list = characters_to_notify

		send_interface_toast = {
			type = event_generic_neutral
			title = minority_faith_appearance_title
			custom_tooltip = minority_faith_appearance_tt
			right_icon = scope:county
		}
	}
}

# scope:source_county
# scope:county
notify_recipient_of_culture_migration_effect = {
	scope:county.holder = {
		add_to_temporary_list = characters_to_notify
		top_liege = {
			if = {
				limit = { is_ai = no }
				add_to_temporary_list = characters_to_notify
			}
			every_vassal_or_below = {
				limit = {
					is_ai = no
					any_sub_realm_county = { this = scope:county }
				}
				add_to_temporary_list = characters_to_notify
			}
		}
	}

	every_in_local_list = {
		list = characters_to_notify

		send_interface_toast = {
			type = event_generic_neutral
			title = minority_culture_appearance_title
			custom_tooltip = minority_culture_appearance_tt
			right_icon = scope:county
		}
	}
}

##### Changed from Vanilla vvvvv

#This is done at a county scope
# $CULTURE_OR_FAITH$: either "culture" or "faith"
demote_least_supported_minority_effect = {
	if = {
		limit = { has_variable_list = $CULTURE_OR_FAITH$_minorities_small }
		every_in_list = { variable = $CULTURE_OR_FAITH$_minorities_small add_to_temporary_list = potential_items }
	}
	if = {
		limit = { has_variable_list = $CULTURE_OR_FAITH$_minorities_large }
		every_in_list = { variable = $CULTURE_OR_FAITH$_minorities_large add_to_temporary_list = potential_items }
	}
	
	ordered_in_list = {
		list = potential_items
		order_by = support_of_a_$CULTURE_OR_FAITH$_minority_in_county
		position = 0
		save_scope_as = item_to_demote
	}
	
	if = {
		limit = { exists = scope:item_to_demote }
		demote_minority_effect = { CULTURE_OR_FAITH = $CULTURE_OR_FAITH$ ITEM = scope:item_to_demote }
		notify_characters_of_minority_reduction_effect = {
			THE_TARGET_COUNTY = scope:target_county
			CULTURE_OR_FAITH = $CULTURE_OR_FAITH$
		}
	}
}
#This is done at a county scope
# $CULTURE_OR_FAITH$: either "culture" or "faith"
demote_an_underfed_minority_effect = {
	if = {
		limit = { has_variable_list = $CULTURE_OR_FAITH$_minorities_small }
		every_in_list = { variable = $CULTURE_OR_FAITH$_minorities_small add_to_temporary_list = potential_items }
	}
	if = {
		limit = { has_variable_list = $CULTURE_OR_FAITH$_minorities_large }
		every_in_list = { variable = $CULTURE_OR_FAITH$_minorities_large add_to_temporary_list = potential_items }
	}
	
	every_in_list = {
		list = potential_items
		if = {
			limit = { this.support_of_a_$CULTURE_OR_FAITH$_minority_in_county > 0 }
			add_to_temporary_list = underfed_minority
		}
	}
	
	ordered_in_list = {
		list = underfed_minority
		order_by = support_of_a_$CULTURE_OR_FAITH$_minority_in_county
		position = 0
		save_scope_as = item_to_demote
	}
	if = {
		limit = { exists = scope:item_to_demote }
		demote_minority_effect = { CULTURE_OR_FAITH = $CULTURE_OR_FAITH$ ITEM = scope:item_to_demote }
		notify_characters_of_minority_reduction_effect = {
			THE_TARGET_COUNTY = scope:target_county
			CULTURE_OR_FAITH = $CULTURE_OR_FAITH$
		}
	}
}
#Requires scope:target_county
immigration_effect = {
	scope:target_county = {
		if = {
			limit = {
				NOT = { culture = scope:target_county.culture }
				NOT = { faith = scope:target_county.faith }
				valid_neighbor_immigration_state_trigger = yes
			}
			random_neighboring_county = {
				limit = {
					NOT = { culture = scope:target_county.culture }
					NOT = { faith = scope:target_county.faith }
					valid_neighbor_immigration_state_trigger = yes
				}
				this = { save_scope_as = source_county }
			}
			#Carry out immigration iff it has some *actual* effect (as in, at least one of 
			#the source's culture/faith is not large
			scope:target_county = {
				if = {
					limit = {
						#AKA, at least one of large faith/culture minorities must not have the 
						#source county's faith/culture
						OR = {
							county_has_a_minority_with_type_and_size_trigger = {
								THE_COUNTY = scope:source_county
								CULTURE_OR_FAITH = culture
								SIZE = large
							}
							county_has_a_minority_with_type_and_size_trigger = {
								THE_COUNTY = scope:source_county
								CULTURE_OR_FAITH = faith
								SIZE = large
							}
						}
					}
					promote_minority_but_not_to_majority_effect = {
						ITEM = scope:source_county.faith
						CULTURE_OR_FAITH = faith
					}
					promote_minority_but_not_to_majority_effect = {
						ITEM = scope:source_county.culture
						CULTURE_OR_FAITH = culture
					}
					notify_characters_of_minority_immigration_effect = {
						THE_SOURCE_COUNTY = scope:source_county
						THE_TARGET_COUNTY = scope:target_county
						EVENT_TITLE = minority_immigration_title
						EVENT_TOOLTIP = minority_immigration_tt
					}
				}
			}
		}
	}
}
#Requires scope:source_county
evangelization_effect = {
	scope:source_county = {
		if = {
			limit = {
				any_neighboring_county = {
					NOT = { faith = scope:source_county.faith }
					faith = { is_valid_evangelizing_target_faith_trigger = yes }
				}
			}
			random_neighboring_county = {
				limit = {
					NOT = { faith = scope:source_county.faith }
					faith = { is_valid_evangelizing_target_faith_trigger = yes }
				}
				### WtWSMS Autocephaly Weights vvv
				weight = {
					base = 1
					#Autocephaly should restrict targeting
					modifier = {
						factor = 2
						scope:source_county.faith = { has_doctrine = tenet_autocephaly }
						actor_is_faith_culture_or_child_culture_for_cultural_religions_trigger = {
							ACTOR = this
							TARGET = scope:source_county
							VARIABLE = church_culture
						}
					}
					modifier = { #Don't commingle autocephalous churches
						factor = 0
						scope:source_county.faith = { has_doctrine = tenet_autocephaly }
						this.faith = { has_doctrine = tenet_autocephaly }
					}
					modifier = { #Don't proselytize autocephalous churches to unrelated cultures
						factor = 0
						scope:source_county.faith = { has_doctrine = tenet_autocephaly }
						NOT = {
							actor_is_faith_culture_or_child_culture_for_cultural_religions_trigger = {
								ACTOR = this
								TARGET = scope:source_county
								VARIABLE = church_culture
							}
						}
					}
				}
				### WtWSMS Autocephaly Weights ^^^
				this = { save_scope_as = target_county }
			}
			#Carry out evangelization
			if = {
				limit = { NOT = { scope:source_county.faith = scope:target_county.faith } }
				scope:target_county = {
					promote_minority_but_not_to_majority_effect = {
						ITEM = scope:source_county.faith
						CULTURE_OR_FAITH = faith
					}
					notify_characters_of_minority_immigration_effect = {
						THE_SOURCE_COUNTY = scope:source_county
						THE_TARGET_COUNTY = scope:target_county
						EVENT_TITLE = minority_faith_evangelization_title
						EVENT_TOOLTIP = minority_faith_evangelization_tt
					}
				}
			}
		}
	}
}

### General Routines

#This is done at a county scope
# $ITEM$ = a scoped faith or culture
# $CULTURE_OR_FAITH$: either "culture" or "faith"
promote_minority_but_not_to_majority_effect = {
	if = {
		limit = {
			has_variable_list = $CULTURE_OR_FAITH$_minorities_small
			is_target_in_variable_list = { name = $CULTURE_OR_FAITH$_minorities_small target = $ITEM$ }
		}
		add_to_variable_list = { name = $CULTURE_OR_FAITH$_minorities_large target = $ITEM$ }
		remove_list_variable = { name = $CULTURE_OR_FAITH$_minorities_small target = $ITEM$ }
	}
	#Large minorities should not become majorities
	else_if = {
		limit = {
			has_variable_list = $CULTURE_OR_FAITH$_minorities_large
			is_target_in_variable_list = { name = $CULTURE_OR_FAITH$_minorities_large target = $ITEM$ }
		}
	}
	else = { add_to_variable_list = { name = $CULTURE_OR_FAITH$_minorities_small target = $ITEM$ } }
}
#This is done at a county scope
# $ITEM$ = a scoped faith or culture
# $CULTURE_OR_FAITH$: either "culture" or "faith"
demote_minority_effect = {
	if = {
		limit = {
			has_variable_list = $CULTURE_OR_FAITH$_minorities_large
			is_target_in_variable_list = { name = $CULTURE_OR_FAITH$_minorities_large target = $ITEM$ }
		}
		remove_list_variable = { name = $CULTURE_OR_FAITH$_minorities_large target = $ITEM$ }
		add_to_variable_list = { name = $CULTURE_OR_FAITH$_minorities_small target = $ITEM$ }
	}
	else_if = {
		limit = {
			has_variable_list = $CULTURE_OR_FAITH$_minorities_small
			is_target_in_variable_list = { name = $CULTURE_OR_FAITH$_minorities_small target = $ITEM$ }
		}
		remove_list_variable = { name = $CULTURE_OR_FAITH$_minorities_small target = $ITEM$ }
	}
}

### Notification routines
notify_characters_of_minority_reduction_effect = {
	$THE_TARGET_COUNTY$.holder = {
		add_to_temporary_list = characters_to_notify
		top_liege = {
			if = { limit = { is_ai = no } add_to_temporary_list = characters_to_notify }
			every_vassal_or_below = {
				limit = {
					is_ai = no
					any_sub_realm_county = { this = $THE_TARGET_COUNTY$ }
				}
				add_to_temporary_list = characters_to_notify
			}
		}
	}
	
	every_in_local_list = {
		list = characters_to_notify
		if = {
			limit = {
				$THE_TARGET_COUNTY$ = { has_variable_list = $CULTURE_OR_FAITH$_minorities_large }
				$THE_TARGET_COUNTY$ = {
					is_target_in_variable_list = {
						name = $CULTURE_OR_FAITH$_minorities_large
						target = scope:item_to_demote
					}
				}
			}
			debug_log = "common/scripted_effects/sea_minority_effects.txt: HAD A CULTURAL/RELIGIOUS MINORITY REDUCTION THAT WAS STILL EXTANT IN LARGE MINORITIES"
		}
		else_if = {
			limit = {
				$THE_TARGET_COUNTY$ = { has_variable_list = $CULTURE_OR_FAITH$_minorities_small }
				$THE_TARGET_COUNTY$ = {
					is_target_in_variable_list = {
						name = $CULTURE_OR_FAITH$_minorities_small
						target = scope:item_to_demote
					}
				}
			}
			send_interface_toast = {
				type = event_generic_neutral
				title = minority_$CULTURE_OR_FAITH$_declined_title
				custom_tooltip = minority_$CULTURE_OR_FAITH$_declined_tt
				right_icon = $THE_TARGET_COUNTY$
			}
		}
		else = {
			send_interface_toast = {
				type = event_generic_neutral
				title = minority_$CULTURE_OR_FAITH$_disappeared_title
				custom_tooltip = minority_$CULTURE_OR_FAITH$_disappeared_tt
				right_icon = $THE_TARGET_COUNTY$
			}
		}
	}
}

notify_characters_of_minority_immigration_effect = {
	$THE_SOURCE_COUNTY$.holder = {
		add_to_temporary_list = characters_to_notify
		top_liege = {
			if = { limit = { is_ai = no } add_to_temporary_list = characters_to_notify }
			every_vassal_or_below = {
				limit = {
					is_ai = no
					any_sub_realm_county = { this = $THE_SOURCE_COUNTY$ }
				}
				add_to_temporary_list = characters_to_notify
			}
		}
	}
	$THE_TARGET_COUNTY$.holder = {
		add_to_temporary_list = characters_to_notify
		top_liege = {
			if = { limit = { is_ai = no } add_to_temporary_list = characters_to_notify }
			every_vassal_or_below = {
				limit = {
					is_ai = no
					any_sub_realm_county = { this = $THE_TARGET_COUNTY$ }
				}
				add_to_temporary_list = characters_to_notify
			}
		}
	}
	
	every_in_local_list = {
		list = characters_to_notify
		if = {
			send_interface_toast = {
				type = event_generic_neutral
				title = $EVENT_TITLE$
				custom_tooltip = $EVENT_TOOLTIP$
				right_icon = $THE_TARGET_COUNTY$
			}
		}
	}
}
##### Changed from Vanilla ^^^^^