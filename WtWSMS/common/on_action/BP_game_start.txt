#Some of this taken from "Successions Expanded" and modified

on_game_start = {
	on_actions = { bp_game_start }
}

on_game_start_after_lobby = {
	on_actions = { bp_game_start_after_lobby }
}

bp_game_start = {
	effect = { every_culture_global = { ccu_initialize_culture_effect = yes } }
	on_actions = {
		#Needs to be done first to avoid some errors
		ccu_startup_debug
		#Other BP Stuff
		BP_character_events
		BP_set_government_id_effects
		create_BP_artifacts
		#Legal Stuff
		game_start_fix_barony_government
		setup_realm_laws
		setup_realm_and_title_succession_laws
		setup_administrative_languages
		setup_vassal_contracts
		#Other Title effects
		other_title_effects
		#Religious Stuff
		set_autocephalous_church_flags
		convert_christian_chars_to_rites
		set_ethnic_religion_flags
		other_religion_effects
		#Family Stuff
		set_dead_dynasty_renown
	}
}

bp_game_start_after_lobby = {
	on_actions = {
		# Culture stuff
		set_starting_culture_acceptance
		#Other Events
		trigger_needed_events
		set_global_variables
		delay = { days = 1 }
		fix_custom_character_governments
	}
}

## CCU Stuff
ccu_startup_debug = {
	effect = {
		every_culture_global = {
			if = {
				limit = { NOT = { has_variable = heritage_group } }
				save_scope_as = problem_culture
				every_player = {
					send_interface_message = {
						type = event_steward_task_bad
						title = ccu_debug_culture_heritage_group
						desc = ccu_debug_culture_heritage_group_desc
					}
				}
			}
			else_if = {
				limit = { NOT = { has_variable = heritage_family } }
				save_scope_as = problem_culture
				every_player = {
					send_interface_message = {
						type = event_steward_task_bad
						title = ccu_debug_culture_heritage_family
						desc = ccu_debug_culture_heritage_family_desc
					}
				}
			}
			if = {
				limit = { NOT = { has_variable = language_group } }
				save_scope_as = problem_culture
				every_player = {
					send_interface_message = {
						type = event_steward_task_bad
						title = ccu_debug_culture_language_group
						desc = ccu_debug_culture_language_group_desc
					}
				}
			}
			else_if = {
				limit = { NOT = { has_variable = language_family } }
				save_scope_as = problem_culture
				every_player = {
					send_interface_message = {
						type = event_steward_task_bad
						title = ccu_debug_culture_language_family
						desc = ccu_debug_culture_language_family_desc
					}
				}
			}
			else_if = {
				limit = { NOT = { has_variable = language_union } }
				save_scope_as = problem_culture
				every_player = {
					send_interface_message = {
						type = event_steward_task_bad
						title = ccu_debug_culture_language_union
						desc = ccu_debug_culture_language_union_desc
					}
				}
			}
		}
	}
}

## Other BP Stuff
BP_character_events = {
	effect = {
		character:93 = { #Genseric of the Vandals
			if = {
				limit = {
					is_alive = yes
					is_landed = yes
				}
				save_scope_as = geneseric
				trigger_event = { id = bp_historical_flavor.0001 days = 1 } #Vandals have lots of Roman slaves at start
			}
		}
	}
}

BP_set_government_id_effects = {
	effect = {
		every_ruler = { set_government_id_effect = { THE_RULER = this } }
	}
}

create_BP_artifacts = {
	effect = {
		if = {
			limit = { has_dlc_feature = royal_court }
			#Tooth of the Buddha
			title:k_lanka.holder = {
				save_scope_as = the_holder
				create_artifact = {
					name = tooth_of_the_buddha
					description = tooth_of_the_buddha_desc
					history = { type = created_before_history }
					type = pedestal
					template = buddhism_artifact_template
					quality = 999
					decaying = no
					modifier = tooth_of_the_buddha_modifier
					visuals = bone
					save_scope_as = tooth_of_the_buddha_scope
				}
				scope:tooth_of_the_buddha_scope = {
					set_variable = { # required to track usability for template
						name = saint_bone_faith
						value = scope:the_holder.faith
					}
				}
			}
			title:e_byzantium.holder = {
				create_artifact = {
					name = nail_of_the_true_cross
					description = nail_of_the_true_cross_desc
					history = { type = created_before_history }
					type = pedestal
					template = christian_relic_template
					quality = 999
					decaying = no
					modifier = nail_of_the_true_cross_modifier
					visuals = reliquary
				}
			}
			title:e_persia.holder = {
				create_artifact = {
					name = branch_of_the_keshmar_cypress
					description = branch_of_the_keshmar_cypress_desc
					history = { type = created_before_history }
					type = pedestal
					template = zoroastrian_relic_template
					quality = 999
					decaying = no
					modifier = branch_of_the_keshmar_cypress_modifier
					visuals = flowers
				}
			}
		}
	}
}

## Legal Stuff
setup_realm_laws = {
	effect = {
		#Set-up Subroman Taxation
		every_ruler = {
			limit = { has_government = subroman_government }
			add_realm_law_skip_effects = subroman_taxation_3
		}
		#Setup Bureaucratic Taxation
		every_ruler = {
			limit = { has_government = bureaucratic_government }
			add_realm_law_skip_effects = bureaucratic_taxation_2
			apply_taxation_down_tree_effect = { VALUE = 2 }
		}
		#Setup e_persia's clerical/shah authority
		#Initally strong Clerical Influence and weak Secular Authority
		if = {
			limit = { current_date >= 476.2.2 }
			every_ruler = {
				limit = { has_title = title:e_persia }
				if = {
					limit = { NOT = { has_realm_law = eranshar_authority_0 } }
					add_realm_law = eranshar_authority_0
					remove_variable = eranshar_authority_cooldown
				}
				if = {
					limit = { NOT = { has_realm_law = clerical_influence_1 } }
					add_realm_law = clerical_influence_1
					remove_variable = clerical_influence_cooldown
				}
			}
		}
	}
}
#These follow the following pattern:
# By culture, by government, then by specific titles, finally specific title overwrites after 476.2.2
# To make it so we can systematically add specific laws, then overwrite for exceptions
setup_realm_and_title_succession_laws = {
	effect = {
		### Cultures
		every_ruler = { #Cultures/Religions with male_only_law effects
			limit = {
				OR = {
					culture = { has_cultural_parameter = male_only_inheritance }
					has_religion = religion:islam_religion
				}
				NOT = { has_realm_law = male_only_law }
			}
			add_realm_law_skip_effects = male_only_law
		}
		every_ruler = { #Cultures/Religions with female_preference_law effects
			limit = {
				culture = {
					has_cultural_parameter = female_only_inheritance
					has_cultural_parameter = not_male_succession
				}
				NOT = { has_realm_law = female_preference_law }
			}
			add_realm_law_skip_effects = female_preference_law
		}
		every_ruler = { #Confederate Partition
			limit = {
				culture = { has_cultural_parameter = gender_equal_inheritance }
				NOT = { has_realm_law = equal_law }
			}
			add_realm_law_skip_effects = equal_law
		}
		every_ruler = { #High Partition
			limit = {
				culture = { has_cultural_parameter = can_enact_high_partition_succession_law }
				NOT = { has_realm_law = high_partition_succession_law }
			}
			add_realm_law_skip_effects = high_partition_succession_law
		}
		every_ruler = { #Equal Succession
			limit = {
				culture = { has_cultural_parameter = must_use_confederate_partition }
				NOT = { has_realm_law = confederate_partition_succession_law }
			}
			add_realm_law_skip_effects = confederate_partition_succession_law
		}
		
		### Governments
		every_ruler = { #Bureaucratic
			limit = { has_government = bureaucratic_government }
			if = {
				limit = { NOT = { has_realm_law = single_heir_succession_law } }
				add_realm_law_skip_effects = single_heir_succession_law
			}
		}
		every_ruler = { #Gubernatorial
			limit = { has_government = gubernatorial_government }
			if = {
				limit = { NOT = { has_realm_law = single_heir_succession_law } }
				add_realm_law_skip_effects = single_heir_succession_law
			}
		}
		every_ruler = { #Eranshar
			limit = { has_government = eranshar_government }
			if = {
				limit = { NOT = { has_realm_law = single_heir_dynasty_house } }
				add_realm_law_skip_effects = single_heir_dynasty_house
			}
		}
		
		### Other Special Cases
		every_ruler = { #The Senate should be male-only republic succession
			limit = { has_title = title:d_senate }
			if = {
				limit = { NOT = { has_realm_law = male_only_law } }
				add_realm_law_skip_effects = male_only_law
			}
			if = {
				limit = { NOT = { has_realm_law = city_succession_law } }
				add_realm_law_skip_effects = city_succession_law
			}
		}
		every_ruler = { #Suebia & Burgundians should be partition partion to avoid creating undesirable kingdoms
			limit = {
				OR = {
					has_title = title:k_suebia
					has_title = title:k_burgundians
				}
			}
			if = {
				limit = { NOT = { has_realm_law = partition_succession_law } }
				add_realm_law_skip_effects = partition_succession_law
			}
		}
		every_ruler = { #Helleno-Roman Sub-Romans should use primogeniture
			limit = { has_title = title:k_taurica }
			if = {
				limit = { NOT = { has_realm_law = single_heir_succession_law } }
				add_realm_law_skip_effects = single_heir_succession_law
			}
		}
		every_ruler = { #Vandals should use Seniority
			limit = { has_title = title:k_vandalica }
			every_vassal_or_below = {
				limit = {
					primary_title.tier >= tier_county
					culture = title:k_vandalica.holder.culture
				}
				if = {
					limit = { NOT = { has_realm_law = single_heir_dynasty_house } }
					add_realm_law_skip_effects = single_heir_dynasty_house
				}
			}
		}
		
		### Specific Title Overwrites
		
		##### TODO (Beta): Remove those that are meaningless based on the above
		
		#Title Succession Laws
		
		#General Title Succession Laws (not tied to a specific title
		
		#Kurultai Elective Succession
		every_independent_ruler = {
			limit = {
				culture = {
					OR = {
						has_cultural_pillar = heritage_mongolic
						has_cultural_pillar = heritage_turkic
					}
					NOT = { this = culture:tuyuhun }
				}
				has_a_primitive_type_of_government_trigger = yes
			}
			every_held_title = {
				limit = { tier >= tier_kingdom }
				add_title_law = kurultai_elective_succession_law
			}
		}
		#Eldership Elective Succession
		every_independent_ruler = {
			limit = {
				OR = {
					has_a_feudal_type_of_government_trigger = yes
					has_government = tribal_government
				}
				OR = {
					this.religion = religion:baltic_religion
					this.religion = religion:west_african_religion
					this.religion = religion:akom_religion
					this.religion = religion:west_african_roog_religion
					this.religion = religion:west_african_orisha_religion
				}
			}
			every_held_title = {
				limit = { tier >= tier_duchy }
				add_title_law = eldership_elective_succession_law
			}
		}
		#Scandinavian Elective
		every_independent_ruler = {
			limit = {
				culture = { has_cultural_parameter = scandinavian_elective_enabled }
				highest_held_title_tier >= tier_duchy
				OR = {
					has_a_feudal_type_of_government_trigger = yes
					has_government = tribal_government
				}
			}
			this.primary_title = { add_title_law = scandinavian_elective_succession_law }
		}
		#Witangamot
		every_independent_ruler = {
			limit = {
				culture = { has_cultural_parameter = witenagemot_succession_enabled }
				highest_held_title_tier >= tier_kingdom
				OR = {
					has_a_feudal_type_of_government_trigger = yes
					has_government = tribal_government
				}
			}
			this.primary_title = { add_title_law = saxon_elective_succession_law }
		}
		
		#Title Elective Laws Tied to Specific Titles
		
		#Eranshar Elective
		every_ruler = {
			every_held_title = {
				limit = { this = title:e_persia }
				add_title_law = mahestan_elective_succession_law
			}
		}
		#Imperial Elective
		every_ruler = {
			every_held_title = {
				limit = {
					OR = {
						this = title:e_byzantium
						this = title:e_wre
						this = title:e_roman_empire
					}
				}
				add_title_law = imperial_elective_succession_law
			}
		}
		#Feudal Elective
		every_ruler = {
			every_held_title = {
				limit = {
					OR = {
						this = title:k_gallaecia
						this = title:k_lombardia
						
						this = title:k_suebia
						#Tarim Basin/Central Asia
						this = title:k_kucha
						this = title:d_bukhara
						this = title:d_chah
						this = title:d_ferghana
						this = title:d_khotan
						this = title:d_khuttal
						this = title:d_merv
						this = title:d_osrushana
						this = title:d_samarkand
					}
				}
				add_title_law = feudal_elective_succession_law
			}
		}
		#Gaelic Elective Succession
		every_ruler = {
			every_held_title = {
				limit = {
					OR = {
						this = title:k_brittany
						this = title:k_dal_riata
						this = title:d_aileach
						this = title:d_astures
						this = title:d_brittany
						this = title:d_broerec
						this = title:d_cait
						this = title:d_ce
						this = title:d_connacht
						this = title:d_western_isles #Creones
						this = title:d_deasmhumhain
						this = title:d_domnonia
						this = title:d_fortriu
						this = title:d_fotla
						this = title:d_kernev
						this = title:d_leinster
						this = title:d_meath
						this = title:d_munster
						this = title:d_ulster
					}
				}
				add_title_law = gaelic_elective_succession_law
			}
		}
		#Tribal Elective Succession
		every_ruler = {
			every_held_title = {
				limit = {
					OR = {
						this = title:k_masmuda
						#Turkic Succession
						this = title:k_al_hirah ##### TODO (Beta): Implement succ_turkish_succession law
						this = title:k_arabia_petraea ##### TODO (Beta): Implement succ_turkish_succession law
						this = title:k_qaryat_dhat_kahil ##### TODO (Beta): Implement succ_turkish_succession law
					}
				}
				add_title_law = tribal_elective_succession_law
			}
		}
		
		#Realm Succession Laws: Sex
		
		#Male Only
		every_ruler = {
			limit = {
				OR = {
					has_title = title:e_axum
					has_title = title:k_england
					has_title = title:k_gallaecia
					#Persians
					has_title = title:e_persia
					has_title = title:k_persia
					has_title = title:d_fars
					#Romans/Byzantines
					has_title = title:e_byzantium
					has_title = title:e_wre
					has_title = title:k_dalmatia
					has_title = title:k_italia
					has_title = title:k_soissons
					has_title = title:d_constantinopolitan_prefect
					has_title = title:d_gaul_prefect
					has_title = title:d_isauria
					has_title = title:d_roman_prefect
					has_title = title:d_tangiers
					has_title = title:d_triveria
					#Germans
					has_title = title:k_alamannia
					has_title = title:k_geatland
					has_title = title:k_italy
					has_title = title:k_lombardia
					has_title = title:k_ostrogoths
					has_title = title:k_suebia
					has_title = title:k_thuringia
					has_title = title:k_vandalica
					has_title = title:d_germanii
					has_title = title:d_thracian_goths
					#Franks
					has_title = title:k_franks
					#Celts
					has_title = title:d_aileach
					has_title = title:d_connacht
					has_title = title:d_deasmhumhain
					has_title = title:d_leinster
					has_title = title:d_meath
					has_title = title:d_munster
					has_title = title:d_ulster
					#Semites
					has_title = title:k_al_hirah
					has_title = title:k_arabia_petraea
					has_title = title:k_qaryat_dhat_kahil
					has_title = title:k_yemen
					#Berbers
					has_title = title:k_gaetulia
					has_title = title:k_garamantes
					has_title = title:k_masmuda
					has_title = title:k_mauretania
					#Altaics
					has_title = title:e_rouran
					has_title = title:e_turkestan
				}
			}
			add_realm_law_skip_effects = male_only_law
		}
		
		#Equal Succession
		every_ruler = {
			limit = {
				OR = {
					has_title = title:k_angloland
					has_title = title:k_frisia
				}
			}
			add_realm_law_skip_effects = equal_law
		}
		
		#Realm Succession Laws: Order
		
		#Primogeniture Succession
		every_ruler = {
			limit = {
				OR = {
					#Romans/Byzantines
					has_title = title:k_soissons
					has_title = title:d_isauria
					has_title = title:d_tangiers
					has_title = title:d_thracian_goths
					has_title = title:d_triveria
					#Persians
					has_title = title:e_persia
					has_title = title:k_persia
					has_title = title:d_fars
					has_title = title:d_khorezm
					#Altaics
					has_title = title:e_rouran
					has_title = title:e_turkestan
					#Berbers
					has_title = title:k_mauretania
					#Semites
					has_title = title:k_yemen
					#Germans
					has_title = title:k_italy
					has_title = title:k_ostrogoths
				}
				NOT = { has_realm_law = single_heir_succession_law }
			}
			add_realm_law_skip_effects = single_heir_succession_law
		}
		#Seniority Succession
		every_ruler = {
			limit = {
				OR = {
					#East Africans
					has_title = title:e_axum
					#Romans/Byzantines
					has_title = title:k_england
					#Persians
					has_title = title:d_exilarch
					#Berbers
					has_title = title:k_gaetulia
					has_title = title:k_garamantes
					#Germans
					has_title = title:k_vandalica
					has_title = title:k_geatland
					#Armenians
					has_title = title:d_syunik
				}
				NOT = { has_realm_law = single_heir_dynasty_house }
			}
			add_realm_law_skip_effects = single_heir_dynasty_house
		}
		### Specific History Overwrites
		if = { #Visigoths adopt elective
			limit = { current_date >= 531.1.1 }
			title:k_visigoths = { add_title_law = feudal_elective_succession_law }
		}
	}
}
setup_administrative_languages = {
	effect = {
		#Set some court langauge variables for bureaucrats
		title:e_wre = {
			set_variable = {
				name = court_language
				value = culture:roman
			}
		}
		title:e_byzantium = {
			if = {
				limit = { current_date < 610.10.5 }
				set_variable = {
					name = court_language
					value = culture:roman
				}
			}
			else = {
				set_variable = {
					name = court_language
					value = culture:greek
				}
			}
		}
		#Byzantines use Latin before Hearclius' reign
		#Source: Davis, Leo Donald (1990). The First Seven Ecumenical Councils (325–787): Their History and Theology. Liturgical Press. p. 260. 
		every_ruler = {
			limit = { has_title = title:e_byzantium }
			if = {
					limit = { current_date < 610.10.5 }
					setup_the_court_language_effect = {
						CHAR = this
						LANGUAGE = language_latin
					}
				}
				else = { #Otherwise, learn Greek
					if = {
						limit = { primary_title = { tier >= tier_kingdom } }
							setup_the_court_language_effect = {
							CHAR = this
							LANGUAGE = language_greek
						}
					}
					else = {
						setup_learnt_language_effect = {
							CHAR = this
							LANGUAGE = language_greek
						}
					}
				}
			every_vassal_or_below = {
				limit = { has_government = gubernatorial_government }
				if = {
					limit = { current_date < 610.10.5 }
					if = {
						limit = { primary_title = { tier >= tier_kingdom } }
							setup_the_court_language_effect = {
							CHAR = this
							LANGUAGE = language_latin
						}
					}
					else = {
						setup_learnt_language_effect = {
							CHAR = this
							LANGUAGE = language_latin
						}
					}
				}
				else = { #Otherwise, learn Greek
					if = {
						limit = { primary_title = { tier >= tier_kingdom } }
							setup_the_court_language_effect = {
							CHAR = this
							LANGUAGE = language_greek
						}
					}
					else = {
						setup_learnt_language_effect = {
							CHAR = this
							LANGUAGE = language_greek
						}
					}
				}
			}
		}
		#Gupta Governments use Sanskrit
		every_ruler = {
			limit = { has_government = gupta_government }
			if = {
				limit = { primary_title = { tier >= tier_kingdom } }
				setup_the_court_language_effect = {
					CHAR = this
					LANGUAGE = language_sanskrit
				}
			}
			else = { #Ensure every Gupta ruler knows Sanskrit
				setup_learnt_language_effect = {
					CHAR = this
					LANGUAGE = language_sanskrit
				}
			}
		}
		#Sub-Romans (in 476 at least) use Latin
		every_ruler = {
			limit = { has_government = subroman_government }
			if = {
				limit = { primary_title = { tier >= tier_kingdom } }
				setup_the_court_language_effect = {
					CHAR = this
					LANGUAGE = language_latin
				}
			}
			else = { #Ensure every Sub-Roman ruler knows Latin
				setup_learnt_language_effect = {
					CHAR = this
					LANGUAGE = language_latin
				}
			}
		}
		#Standardize use of Persian under e_persia
		every_ruler = {
			limit = { has_title = title:e_persia }
			every_vassal_or_below = {
				if = {
					limit = { #Eranshar Zoroastrian Vassals Under Persia (only) should adopt Persian
						primary_title = { tier >= tier_kingdom }
						AND = {
							has_government = eranshar_government
							has_religion = religion:zoroastrianism_religion
						}
					}
					setup_the_court_language_effect = {
						CHAR = this
						LANGUAGE = language_iranian
					}
				}
				else = {
					setup_learnt_language_effect = {
						CHAR = this
						LANGUAGE = language_iranian
					}
				}
			}
		}
		#All learned Jewish rulers should know Hebrew
		every_ruler = {
			limit = {
				OR = {
					culture = { has_cultural_pillar = heritage_israelite }
					religion = religion:judaism_religion
				}
			}
			setup_learnt_language_effect = {
				CHAR = this
				LANGUAGE = language_israelite
			}
		}
	}
}
#Ensure all baronies have appropriate governments for game start; prevents clan/feudalism sneaking
#in through the back door
game_start_fix_barony_government = {
	effect = {
		every_barony = {
			#Which isn't a capital
			limit = { is_capital_barony = no }
			#All castle holders should have the government of the county holder
			if = {
				limit = { this.title_province = { has_holding_type = castle_holding } }
				#Vanilla Governments
				if = {
					limit = { this.county.holder = { has_government = tribal_government } }
					this.holder = { convert_realm_to_tribal_effect = yes }
				}
				else_if = { #NB: Causes singular "illegal_government" error in 476 start
					limit = { this.county.holder = { has_government = republic_government } }
					this.holder = { convert_realm_to_republic_effect = yes }
				}
				else_if = {
					limit = { this.county.holder = { has_government = theocracy_government } }
					this.holder = { convert_realm_to_theocracy_effect = yes }
				}
				#BP Governments
				else_if = {
					limit = { this.county.holder = { has_government = high_tribal_government } }
					this.holder = { convert_realm_to_high_tribal_effect = yes }
				}
				else_if = {
					limit = { this.county.holder = { has_government = prefeudal_government } }
					this.holder = { convert_realm_to_prefeudal_effect = yes }
				}
				else_if = {
					limit = { this.county.holder = { has_government = nomad_government } }
					this.holder = { convert_realm_to_nomad_effect = yes }
				}
				else_if = {
					limit = { this.county.holder = { has_government = subroman_government } }
					this.holder = { convert_realm_to_subroman_direct_effect = yes }
				}
				else_if = {
					limit = { this.county.holder = { has_government = eranshar_government } }
					this.holder = { convert_realm_to_eranshar_effect = yes }
				}
				else_if = {
					limit = { this.county.holder = { has_government = gupta_government } }
					this.holder = { convert_realm_to_gupta_effect = yes }
				}
				else_if = {
					limit = { this.county.holder = { has_bureaucratic_government_type_trigger = yes } }
					this.holder = { convert_realm_to_gubernatorial_effect = yes }
				}
			}
			#Handle cases of lay clergy faiths holding temples as well
			else_if = {
				limit = {
					this.title_province = { has_holding_type = church_holding }
					this.holder.faith = { has_doctrine = doctrine_theocracy_lay_clergy }
				}
				#Vanilla Governments
				if = {
					limit = { this.county.holder = { has_government = tribal_government } }
					this.holder = { convert_realm_to_tribal_effect = yes }
				}
				else_if = {
					limit = { this.county.holder = { has_government = republic_government } }
					this.holder = { convert_realm_to_republic_effect = yes }
				}
				else_if = {
					limit = { this.county.holder = { has_government = theocracy_government } }
					this.holder = { convert_realm_to_theocracy_effect = yes }
				}
				#BP Governments
				else_if = {
					limit = { this.county.holder = { has_government = high_tribal_government } }
					this.holder = { convert_realm_to_high_tribal_effect = yes }
				}
				else_if = {
					limit = { this.county.holder = { has_government = prefeudal_government } }
					this.holder = { convert_realm_to_prefeudal_effect = yes }
				}
				else_if = {
					limit = { this.county.holder = { has_government = nomad_government } }
					this.holder = { convert_realm_to_nomad_effect = yes }
				}
				else_if = {
					limit = { this.county.holder = { has_government = subroman_government } }
					this.holder = { convert_realm_to_subroman_direct_effect = yes }
				}
				else_if = {
					limit = { this.county.holder = { has_government = eranshar_government } }
					this.holder = { convert_realm_to_eranshar_effect = yes }
				}
				else_if = {
					limit = { this.county.holder = { has_government = gupta_government } }
					this.holder = { convert_realm_to_gupta_effect = yes }
				}
				else_if = {
					limit = { this.county.holder = { has_bureaucratic_government_type_trigger = yes } }
					this.holder = { convert_realm_to_gubernatorial_effect = yes }
				}
			}
		}
	}
}
setup_vassal_contracts = {
	effect = {
		every_ruler = {
			if = { #k_mazandaran always has great rights
				limit = { primary_title = title:k_mazandaran }
				vassal_contract_set_obligation_level = {
					type = religious_rights
					level = 1
				}
				vassal_contract_set_obligation_level = {
					type = title_revocation_rights
					level = 1
				}
				vassal_contract_set_obligation_level = {
					type = war_declaration_rights
					level = 1
				}
				vassal_contract_set_obligation_level = {
					type = prefeudal_government_obligation
					level = 0
				}
			}
			if = { #Thracian Goths are always foederati
				limit = { primary_title = title:d_thracian_goths }
				vassal_contract_set_obligation_level = {
					type = foederatus_special_contract
					level = 1
				}
			}
			if = { #Ghasanids are always foederati
				limit = { primary_title = title:k_arabia_petraea }
				vassal_contract_set_obligation_level = {
					type = foederatus_special_contract
					level = 1
				}
			}
			if = { #Salihids are always foederati
				limit = { primary_title = title:k_salihid }
				vassal_contract_set_obligation_level = {
					type = foederatus_special_contract
					level = 1
				}
			}
			if = { #Sarir is always a Byzantine Tributary
				limit = { primary_title = title:k_sarir }
				vassal_contract_set_obligation_level = {
					type = tributary_state_special_contract
					level = 1
				}
			}
			if = { #Lazica is always a Byzantine Tributary
				limit = { primary_title = title:k_lazica }
				vassal_contract_set_obligation_level = {
					type = tributary_state_special_contract
					level = 1
				}
			}
			if = { #Albania is always a Persian Tributary
				limit = {
					OR = {
						primary_title = title:k_caucasian_albania
						primary_title = title:d_caucasian_albania
					}
				}
				vassal_contract_set_obligation_level = {
					type = tributary_state_special_contract
					level = 1
				}
			}
			if = { #Iberia is always a Persian Tributary
				limit = { primary_title = title:k_iberia }
				vassal_contract_set_obligation_level = {
					type = tributary_state_special_contract
					level = 1
				}
			}
			if = { #Lakhmids are always presian tributary
				limit = { primary_title = title:k_al_hirah }
				vassal_contract_set_obligation_level = {
					type = tributary_state_special_contract
					level = 1
				}
			}
			if = { #d_sophanene, d_sophene have some nice rights
				limit = {
					OR = {
						primary_title = title:d_sophene
						primary_title = title:d_sophanene
					}
				}
				vassal_contract_set_obligation_level = {
					type = religious_rights
					level = 1
				}
				vassal_contract_set_obligation_level = {
					type = title_revocation_rights
					level = 1
				}
			}
			#Everyone under e_xiongnu is a tributary... except d_chach
			if = {
				limit = {
					this.liege.primary_title = title:e_xiongnu
					this.primary_title.tier >= tier_duchy
					NOT = { this.primary_title = title:d_chah }
					NOT = { this.primary_title = title:e_xiongnu } #Excluded the holder of e_xiongnu (not a vassal)
				}
				debug_log_scopes = no
				vassal_contract_set_obligation_level = {
					type = tributary_special_contract
					level = 1
				}
			}
			if = { #Vassals of the Gupta Empire are militarily oriented
				limit = {
					liege.primary_title = title:e_rajastan
					primary_title.tier >= tier_duchy
					NOT = { this.primary_title = title:e_rajastan } #Excluded the holder of rajasthan (not a vassal)
					has_government = gupta_government
				}
				debug_log_scopes = no
				vassal_contract_set_obligation_level = {
					type = gupta_government_taxes
					level = 1
				}
				vassal_contract_set_obligation_level = {
					type = gupta_government_levies
					level = 3
				}
			}
			if = { #Non-Tributary Prefeudal Christian Vassals of Persia have religious freedom
				limit = {
					has_government = prefeudal_government
					OR = {
						faith = faith:rabbinism
						faith = faith:assyrian_pagan
					}
					any_liege_or_above = { this.primary_title = title:e_persia }
					AND = {
						valid_government_religious_rights_trigger = yes
						NOT = { bp_special_contract_protects_religion_trigger = { VASSAL = this } }
					}
				}
				vassal_contract_set_obligation_level = {
					type = religious_rights
					level = 1
				}
			}
			#e_rouran Tributaries
			if = {
				limit = { primary_title = title:k_gaochang }
				debug_log_scopes = no
				vassal_contract_set_obligation_level = {
					type = tributary_state_special_contract
					level = 1
				}
			}
		}
	}
}
other_title_effects = {
	effect = {
		#Check the status of k_vandalica's name
		update_name_of_vandal_kingdom_effect = yes
		#Unrevokable titles
		every_duchy = {
			limit = { this = title:d_senate }
			this = { set_variable = unrevokable }
		}
		#Capital changes for specific time periods
		title:k_ostrogoths.holder = {
			if = { #Odoacer's death/Theodoric's conquest of Italy
				limit = { current_date <= 493.2.25 }
				set_realm_capital = title:c_szerem
			}
		}
		title:k_visigoths.holder = {
			if = { #Franks force the capital south
			limit = {
					AND = {
						current_date > 507.1.1
						current_date < 542.1.1
					}
				}
				set_realm_capital = title:c_barcelona
			}
			else_if = { #Final move to Toledo
				limit = { current_date >= 542.1.1 }
				set_realm_capital = title:c_toledo
			}
		}
		title:k_yarlung.holder = {
			if = {
				limit = { current_date < 637.1.1 }
				set_realm_capital = title:c_zetang
			}
		}
		#Make some titular titles align with specific lieges
		if = {
			limit = { current_date = 476.2.2 }
			#k_armenia
			title:d_gugark = { set_de_jure_liege_title = title:k_armenia }
			title:d_gardman = { set_de_jure_liege_title = title:k_armenia }
			title:d_tayk = { set_de_jure_liege_title = title:k_armenia }
			#e_peria
			title:d_gortyene = { set_de_jure_liege_title = title:k_asoristan }
			title:d_kwrtstan = { set_de_jure_liege_title = title:k_persia }
			title:d_exilarch = { set_de_jure_liege_title = title:k_asoristan }
		}
		#Put specific kingdoms within specific empires where it makes sense
		if = {
			limit = { current_date = 476.2.2 }
			#Britannia
			title:k_rheged = { set_de_jure_liege_title = title:e_britannia }
			#African
			title:k_abyssinia = { set_de_jure_liege_title = title:e_axum }
			#Persia
			title:k_mazandaran = { set_de_jure_liege_title = title:e_persia }
		}
		#Before the Fall of Rome, k_annonaria title should be under the WRE (to give Romulus *some* hope)
		#and to enable de jure drift
		if = {
			limit = { current_date < 476.9.4 }
			title:k_annonaria = { set_de_jure_liege_title = title:e_wre }
		}
		#Note specific kingdoms that are cultural titles (and thus should block creation of any de jure while titular)
		
		#*goths
		title:k_visigoths = { set_variable = { name = title_culture value = culture:visigothic } }
		title:k_ostrogoths = { set_variable = { name = title_culture value = culture:ostrogothic } }
		#Other Germans
		title:k_vandalica = { set_variable = { name = title_culture value = culture:vandalic } }
		title:k_suebia = { set_variable = { name = title_culture value = culture:suebi } }
		title:k_burgundians = { set_variable = { name = title_culture value = culture:burgundian } }
		title:k_alamannia = { set_variable = { name = title_culture value = culture:alamannian } }
		title:k_gepidia = { set_variable = { name = title_culture value = culture:gepid } }
		title:k_herul = { set_variable = { name = title_culture value = culture:heruli } }
		title:k_rugiland = { set_variable = { name = title_culture value = culture:rygir } }
		title:k_thuringia = { set_variable = { name = title_culture value = culture:thuringian } }
		title:k_geatland = { set_variable = { name = title_culture value = culture:geatish } }
		title:k_saxony = { set_variable = { name = title_culture value = culture:old_saxon } }
		#Turco-Mongol-Magyar
		title:k_chuban = { set_variable = { name = title_culture value = culture:xiongnu } }
		title:k_tuyuhun = { set_variable = { name = title_culture value = culture:tuyuhun } }
		title:k_magyar = { set_variable = { name = title_culture value = culture:mogyer } }
	}
}

## Religion Stuff

#Flips Nicene Chars to adopt the appropriate rites
convert_christian_chars_to_rites = {
	effect = {
		#Hispanic Rite
		change_ruler_and_court_rite_by_county_faith_effect = {
			OLD_RITE = nicene
			NEW_RITE = mozarabic_church
		}
		change_ruler_and_court_rite_by_kingdom_effect = {
			OLD_RITE = nicene
			NEW_RITE = mozarabic_church
			KINGDOM = k_lusitania
		}
		change_ruler_and_court_rite_by_kingdom_effect = {
			OLD_RITE = nicene
			NEW_RITE = mozarabic_church
			KINGDOM = k_baetica
		}
		change_ruler_and_court_rite_by_kingdom_effect = {
			OLD_RITE = nicene
			NEW_RITE = mozarabic_church
			KINGDOM = k_gallaecia
		}
		change_ruler_and_court_rite_by_kingdom_effect = {
			OLD_RITE = nicene
			NEW_RITE = mozarabic_church
			KINGDOM = k_tarraconensis
		}
		change_ruler_and_court_rite_by_kingdom_effect = {
			OLD_RITE = nicene
			NEW_RITE = mozarabic_church
			KINGDOM = k_cartaginensis
		}
		#African Rite
		change_ruler_and_court_rite_by_county_faith_effect = {
			OLD_RITE = nicene
			NEW_RITE = african_church
		}
		change_ruler_and_court_rite_by_kingdom_effect = {
			OLD_RITE = nicene
			NEW_RITE = african_church
			KINGDOM = k_mauretania
		}
		change_ruler_and_court_rite_by_kingdom_effect = {
			OLD_RITE = nicene
			NEW_RITE = african_church
			KINGDOM = k_africa
		}
		change_ruler_and_court_rite_by_kingdom_effect = {
			OLD_RITE = nicene
			NEW_RITE = african_church
			KINGDOM = k_tripolitania
		}
		#Gallican Rite
		change_ruler_and_court_rite_by_county_faith_effect = {
			OLD_RITE = nicene
			NEW_RITE = gallican_church
		}
		change_ruler_and_court_rite_by_kingdom_effect = {
			OLD_RITE = nicene
			NEW_RITE = gallican_church
			KINGDOM = k_septem_provincae
		}
		change_ruler_and_court_rite_by_kingdom_effect = {
			OLD_RITE = nicene
			NEW_RITE = gallican_church
			KINGDOM = k_lugdunensis
		}
		change_ruler_and_court_rite_by_kingdom_effect = {
			OLD_RITE = nicene
			NEW_RITE = gallican_church
			KINGDOM = k_brittany
		}
		change_ruler_and_court_rite_by_kingdom_effect = {
			OLD_RITE = nicene
			NEW_RITE = gallican_church
			KINGDOM = k_maxima_sequanorum
		}
		change_ruler_and_court_rite_by_kingdom_effect = {
			OLD_RITE = nicene
			NEW_RITE = gallican_church
			KINGDOM = k_belgica
		}
		#Ethiopian Orthodox
		change_ruler_and_court_rite_by_county_faith_effect = {
			OLD_RITE = miaphysitism
			NEW_RITE = ethiopian_orthodox
		}
		#Handle edge cases:
		character:109769 = { set_character_faith_history = faith:nicene } #Make Erikos the Massalian Nicene
	}
}
set_autocephalous_church_flags = {
	effect = {
		faith:armenian_apostolic = { set_variable = { name = church_culture value = culture:armenian } }
		faith:georgian_orthodox = { set_variable = { name = church_culture value = culture:colchiscan } }
		faith:gothic_church = { set_variable = { name = church_culture value = culture:gothic } }
	}
}
set_ethnic_religion_flags = {
	effect = {
		#Donyipoloism
		faith:sedism = { set_variable = { name = ethnic_religion_culture value = culture:kachari } }
		faith:bathouism = { set_variable = { name = ethnic_religion_culture value = culture:kachari } }
		faith:sanamahi_pagan = { set_variable = { name = ethnic_religion_culture value = culture:meitei } }
		#Dualism
		faith:mandeaism = { set_variable = { name = ethnic_religion_culture value = culture:aramean } }
		faith:sabianism = { set_variable = { name = ethnic_religion_culture value = culture:assyrian } }
		#Hinduism
		faith:kalashism = { set_variable = { name = ethnic_religion_culture value = culture:kalash } }
		faith:nuristanism = { set_variable = { name = ethnic_religion_culture value = culture:nuristani } }
		#Judaism
		faith:samaritan = { set_variable = { name = ethnic_religion_culture value = culture:hebrew } }
		faith:tzadikite = { set_variable = { name = ethnic_religion_culture value = culture:juhuro } }
		faith:haymanot = { set_variable = { name = ethnic_religion_culture value = culture:sidamic } }
		#Munhumism
		faith:kiratism = { set_variable = { name = ethnic_religion_culture value = culture:kirati } }
		faith:yumaism = { set_variable = { name = ethnic_religion_culture value = culture:kirati } }
		#Tengrism
		faith:magyar_pagan  = { set_variable = { name = ethnic_religion_culture value = culture:mogyer } }
		#Hepthalitism
		faith:hepthalitism  = { set_variable = { name = ethnic_religion_culture value = culture:hunas } }
		#Mundaism
		faith:munda_pagan = { set_variable = { name = ethnic_religion_culture value = culture:munda } }
		#Paleo-Balkan
		faith:illyrian_pagan = { set_variable = { name = ethnic_religion_culture value = culture:illyrian } }
		faith:thracian_pagan = { set_variable = { name = ethnic_religion_culture value = culture:thracian } }
	}
}
other_religion_effects = {
	effect = {
		if = { #Treaty of Nvarsak
			limit = { current_date >= 484.1.1 }
			legalize_caucasian_christianity_global_effect = yes
		}
	}
}

## Family Stuff
set_dead_dynasty_renown = {
	effect = {
		#Re-evaluate all of these as dynasty tree is filled out for increased accuracy
		dynasty:israelite_dynn_herodian = { add_dynasty_prestige_level = 1 }
		dynasty:iranian_dynn_achaemenid = { add_dynasty_prestige_level = 4 }
		dynasty:bactrian_dynn_orontid = { add_dynasty_prestige_level = 4 }
		dynasty:104246212 = { add_dynasty_prestige_level = 3 } #Seleucid
		dynasty:macedonian_dynn_Argead = { add_dynasty_prestige_level = 10 } #Alexander the Great
	}
}

## Culture Stuff
set_starting_culture_acceptance = {
	effect = {
		#Will help keep popular revolts suppressed for a while
		#Target Value: >=+0.00 yearly acceptance change without going below zero
		
		if = { #476 Acceptance
			limit = { current_date <= 476.2.2 }
			#Persian Empire
			culture:persian = {
				set_cultural_acceptance = {
					target = culture:parthian
					value = 100
				}
				set_cultural_acceptance = {
					target = culture:bactrian
					value = 100
				}
				set_cultural_acceptance = {
					target = culture:indo_parthian
					value = 90
				}
				set_cultural_acceptance = {
					target = culture:amardian
					value = 83
				}
				set_cultural_acceptance = {
					target = culture:median
					value = 72
				}
				set_cultural_acceptance = {
					target = culture:cyrtian
					value = 60
				}
				set_cultural_acceptance = {
					target = culture:caucasian_albanian
					value = 60
				}
				set_cultural_acceptance = {
					target = culture:daylamite
					value = 57
				}
				set_cultural_acceptance = {
					target = culture:adnanite
					value = 48
				}
				set_cultural_acceptance = {
					target = culture:aramean
					value = 47
				}
				set_cultural_acceptance = {
					target = culture:corduenian
					value = 42
				}
				set_cultural_acceptance = {
					target = culture:georgian
					value = 42
				}
				set_cultural_acceptance = {
					target = culture:armenian
					value = 35
				}
				set_cultural_acceptance = {
					target = culture:adhari
					value = 35
				}
				set_cultural_acceptance = {
					target = culture:afghan
					value = 31
				}
				set_cultural_acceptance = {
					target = culture:khalan
					value = 29
				}
				set_cultural_acceptance = {
					target = culture:romano_aramean
					value = 24
				}
				set_cultural_acceptance = {
					target = culture:assyrian
					value = 17
				}
			}
			#ERE
			culture:greek = {
				set_cultural_acceptance = {
					target = culture:aeolian
					value = 100
				}
				set_cultural_acceptance = {
					target = culture:helleno_thracian
					value = 100
				}
				set_cultural_acceptance = {
					target = culture:phrygian
					value = 92
				}
				set_cultural_acceptance = {
					target = culture:pontic
					value = 90
				}
				set_cultural_acceptance = {
					target = culture:illyrian
					value = 88
				}
				set_cultural_acceptance = {
					target = culture:macronian
					value = 84
				}
				set_cultural_acceptance = {
					target = culture:cappadocian
					value = 80
				}
				set_cultural_acceptance = {
					target = culture:helleno_aramean
					value = 79
				}
				set_cultural_acceptance = {
					target = culture:armenian
					value = 77
				}
				set_cultural_acceptance = {
					target = culture:thracian
					value = 73
				}
				set_cultural_acceptance = {
					target = culture:helleno_coptic
					value = 72
				}
				set_cultural_acceptance = {
					target = culture:tsakonian
					value = 71
				}
				set_cultural_acceptance = {
					target = culture:galatian
					value = 73
				}
				set_cultural_acceptance = {
					target = culture:romano_thracian
					value = 70
				}
				set_cultural_acceptance = {
					target = culture:helleno_libyan
					value = 64
				}
				set_cultural_acceptance = {
					target = culture:khalan
					value = 62
				}
				set_cultural_acceptance = {
					target = culture:nabatean
					value = 60
				}
				set_cultural_acceptance = {
					target = culture:isaurian
					value = 40
				}
				set_cultural_acceptance = {
					target = culture:romano_illyrian
					value = 40
				}
				set_cultural_acceptance = {
					target = culture:adnanite
					value = 36
				}
				set_cultural_acceptance = {
					target = culture:romano_aramean
					value = 23
				}
				set_cultural_acceptance = {
					target = culture:aramean
					value = 23
				}
				set_cultural_acceptance = {
					target = culture:persian
					value = 23
				}
				set_cultural_acceptance = {
					target = culture:coptic
					value = 15
				}
			}
		}
	}
}

trigger_needed_events = {
	effect = {
		#Inform all the players
		every_player = { trigger_event = { id = BP_maintenance_events.0001 } }
	}
}

set_global_variables = {
	#Historically unset variables: rome_restored
	effect = {
		if = { #The Fall of Rome
			limit = { current_date >= 476.9.4 }
			set_global_variable = fall_of_rome
		}
		if = { #Clovis ascends the throne
			limit = { current_date >= 482.1.1 }
			set_global_variable = formed_frankish_kingdom
		}
		if = { #Treaty of Nvarsak
			limit = { current_date >= 484.1.1 }
			set_global_variable = persia_legalizes_caucasian_christianity
		}
		if = { #Vachagan III re-establishes Albania as a kingdom
			limit = { current_date >= 485.1.1 }
			set_global_variable = reestablished_albania
		}
		if = { #Justinian Ascends the Throne (enabling reconquests)
			limit = { current_date >= 527.4.1 }
			set_global_variable = sole_roman_empire
		}
	}
}

fix_custom_character_governments = {
	effect = {
		every_ruler = {
			limit = { is_from_ruler_designer = yes }
			this = { save_temporary_scope_as = the_holder }
			this.primary_title.previous_holder = { save_temporary_scope_as = the_previous_holder }
			
			if = {
				limit = { NOT = { exists = this.primary_title.previous_holder } }
				debug_log = "ERROR: DID NOT FIND PREVIOUS HOLDER FOR CUSTOM RULER"
			}
			
			#Primitive Governments (can hold tribal_holding)
			if = {
				limit = {
					scope:the_previous_holder = {
						has_variable = government_id
						var:government_id = { compare_value = id_tribal_government }
					}
				}
				convert_realm_to_tribal_effect = yes
			}
			else_if = {
				limit = {
					scope:the_previous_holder = {
						has_variable = government_id
						var:government_id = { compare_value = id_nomad_government }
					}
				}
				convert_realm_to_nomad_effect = yes
			}
			else_if = {
				limit = {
					scope:the_previous_holder = {
						has_variable = government_id
						var:government_id = { compare_value = id_high_tribal_government }
					}
				}
				convert_realm_to_high_tribal_effect = yes
			}
			#Intermediate Governments (prefeudal/feudal/clan)
			else_if = {
				limit = {
					scope:the_previous_holder = {
						has_variable = government_id
						var:government_id = { compare_value = id_prefeudal_government }
					}
				}
				convert_realm_to_prefeudal_effect = yes
			}
			else_if = {
				limit = {
					scope:the_previous_holder = {
						has_variable = government_id
						var:government_id = { compare_value = id_feudal_government }
					}
				}
				convert_realm_to_feudal_effect = yes
			}
			else_if = {
				limit = {
					scope:the_previous_holder = {
						has_variable = government_id
						var:government_id = { compare_value = id_clan_government }
					}
				}
				convert_realm_to_clan_effect = yes
			}
			#Advanced Governments
			else_if = {
				limit = {
					scope:the_previous_holder = {
						has_variable = government_id
						var:government_id = { compare_value = id_subroman_government }
					}
				}
				convert_realm_to_subroman_effect = { THE_PREVIOUS_HOLDER = scope:the_previous_holder }
			}
			else_if = {
				limit = {
					scope:the_previous_holder = {
						has_variable = government_id
						var:government_id = { compare_value = id_eranshar_government }
					}
				}
				convert_realm_to_eranshar_effect = yes
			}
			else_if = {
				limit = {
					scope:the_previous_holder = {
						has_variable = government_id
						var:government_id = { compare_value = id_gupta_government }
					}
				}
				convert_realm_to_gupta_effect = yes
			}
			else_if = {
				limit = {
					scope:the_previous_holder = {
						has_variable = government_id
						var:government_id = { compare_value = id_bureaucratic_government }
					}
				}
				convert_realm_to_bureaucratic_just_ruler_effect = yes
			}
			else_if = {
				limit = {
					scope:the_previous_holder = {
						has_variable = government_id
						var:government_id = { compare_value = id_gubernatorial_government }
					}
				}
				convert_realm_to_gubernatorial_effect = yes
			}
			#OTHERS
			else = { debug_log = "ERROR: DID NOT FIND government_id VALUE FOR CUSTOM RULER PREVIOUS HOLDER" }
		}
	}
}
