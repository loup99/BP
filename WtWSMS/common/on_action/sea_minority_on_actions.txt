#### Minority Culture/Faith spread/growth/decline ####
#=====================================================
# Difference from "Cultural and Religious Minorities" is that we utilize quasi-cellular automata
# rules similar to "Conway's Game of Life" to provide a marginally better model in which
# cultures will not spread out overly far from existing concentrations of minorities.
#
#### How many minorities per county? ####
#----------------------------------------
# Every county can support minorities as a function of its development; We will utilize the Lucas
# Sequence Vn(1,−1) [the Lucas Numbers, a series related to the Fibonacci sequence]
#
# 1, 3, 4, 7, 11, 18, 29, 47, 76 ...
#
# 01: 1 minority
# 04: 2 minorities
# 07: 3 minorities
# 11: 4 minorities
# 18: 5 minorities
# 29: 6 minorities
# 47: 7 minorities
# 76: 8 minorities
#
# Each list of culture and faith minorities will be kept separate
#
# We will assign a "small" minority a size of 1 and a large minority a size of 2.
#
# So development (urbanization) allows for greater minority presence.
#
#### How do minorities disappear? ####
#-------------------------------------
# Every so often, a check will be made to see if minorities are being "fed", a measure of how much
# presence the minority has in neighbouring counties. If it is too low, the minority will be
# slated for removal.
#
# Certain combinations of traits, traditions, county features, &c. will impact how well fed
# a minority is.
#
# More frequently, a check is performed when the number of minorities exceeds the capacity of the
# county and removes the least supported minority.
#
#### Which minority disappears first? ####
#-----------------------------------------
# To determine which minority disappears, we will determine support, which considers the
# faiths/minorities of adjoining counties along with specific culture/religion/county features.#
# This notion is similar to, but distinct from, how minorities are "fed"
#
# * A minority population is always "fed" if it is next to a county where it is a majority
#   population.
# * A minority population is fed if it has enough support.
# * Large minorities require at least 4 points of adjoining minorities
#    * Adjoining large minorities are worth 2
# * Small minorities require at least 2 points of adjoining minorities
#    * Adjoining small minorities are worth 1
# * Any minority that is underfed is at risk of disappearing.
#
# NB: Certain traditions (like Diasporic) and doctrines should imply a sorting within the underfed
# population. Diasporic Jewish populations long established themselves in Europe and Asia after
# all.
#
#### How do minorities spread? ####
#----------------------------------
# Minorities spread either via target immigration (the target_county has spare minority capacity),
# or from conditions in a source_county (having an evangelical faith or a noticeable differential
# in development levels between neighbouring counties.
#
# Most effects will **not** let minorities become majorities in these on_actions. The following are
# exceptions:
# * do_outward_immigration (development differential-driven immigration)

yearly_global_pulse = {
	on_actions = {
		on_yearly_sea_minority_maintainance #Target County Driven
		on_yearly_sea_majority_maintainance #Source County Driven
	}
}

three_year_playable_pulse = {
	on_actions = {
		delay = { days = { 30 330 } }
		spawn_minority_characters
	}
}

on_yearly_sea_minority_maintainance = {
	effect = {
		every_county = {
			this = { save_scope_as = target_county }
			
			### Immigration
			if = { #If there are too few minorities, then immigration is possible
				limit = {
					county_has_minority_faith_trigger = yes
					county_has_minority_culture_trigger = yes
					this.number_of_faith_minorities_in_county_weighted <= this.minority_capacity_of_county
					this.number_of_culture_minorities_in_county_weighted <= this.minority_capacity_of_county
				}
				random = {
					chance = chance_of_minority_immigration_event_per_year
					trigger_event = {
						days = { 1 360 }
						on_action = do_immigration
					}
				}
			}
			
		}
	}
}
do_immigration = {
	effect = {
		if = {
			limit = { scope:target_county = { is_valid_immigration_target_county_trigger = yes } }
			inward_immigration_effect = { THE_TARGET_COUNTY = scope:target_county }
		}
	}
}

on_yearly_sea_majority_maintainance = {
	effect = {
		every_county = {
			this = { save_scope_as = source_county }
			
			##### Check Culture/Faith Capacity & Feeding #####
			
			#Keep these on an if/else_if because both should not happen at the same time
			
			### Culture
			if = { #If there are too many minorities, some must die out
				limit = {
					county_has_minority_culture_trigger = yes
					NOT = { has_variable = recently_demoted_culture }
					this.number_of_culture_minorities_in_county_weighted > this.minority_capacity_of_county_culture
				}
				random = {
					chance = chance_of_culture_minority_reduction_event_per_year
					modifier = {
						factor = 0.5
						scope:source_county = { county_checks_culture_overcapacity_less_frequently_trigger = yes }
					}
					modifier = {
						factor = 2.0
						scope:source_county = { county_checks_culture_overcapacity_more_frequently_trigger = yes }
					}
					trigger_event = {
						days = { 1 360 }
						on_action = do_culture_reduction
					}
				}
			}
			else_if = { #There's a chance for underfed minorities to die out
				limit = {
					county_has_minority_culture_trigger = yes
					NOT = { has_variable = recently_checked_underfed_culture }
				}
				random = {
					chance = chance_of_culture_minority_underfed_event_per_year
					#Odds of checking underfed are modified by majority culture ethos
					#so egalitarian/cosmopolitan counties have less pressure to check
					modifier = {
						factor = 0.5
						scope:source_county = { county_checks_culture_underfed_less_frequently_trigger = yes }
					}
					modifier = {
						factor = 2.0
						scope:source_county = { county_checks_culture_underfed_more_frequently_trigger = yes }
					}
					trigger_event = {
						days = { 1 360 }
						on_action = do_culture_minority_underfed
					}
				}
			}
			#Otherwise, keep things as they were
			
			### Faith
			if = { #If there are too many minorities, some must die out
				limit = {
					county_has_minority_faith_trigger = yes
					NOT = { has_variable = recently_demoted_faith }
					this.number_of_faith_minorities_in_county_weighted > this.minority_capacity_of_county_faith
				}
				random = {
					chance = chance_of_faith_minority_reduction_event_per_year
					#Odds of checking being over capacity are modified by majority faith pluralism
					#so pluralist counties have less pressure to check and fundamentalist have more
					modifier = {
						factor = 0.5
						scope:source_county = { county_checks_faith_overcapacity_less_frequently_trigger = yes }
					}
					modifier = {
						factor = 2.0
						scope:source_county = { county_checks_faith_overcapacity_more_frequently_trigger = yes }
					}
					trigger_event = {
						days = { 1 360 }
						on_action = do_faith_reduction
					}
				}
			}
			else_if = { #There's a chance for underfed minorities to die out
				limit = {
					county_has_minority_faith_trigger = yes
					NOT = { has_variable = recently_checked_underfed_faith }
				}
				random = {
					chance = chance_of_faith_minority_underfed_event_per_year
					modifier = {
						factor = 0.5
						scope:source_county = { county_checks_faith_underfed_less_frequently_trigger = yes }
					}
					modifier = {
						factor = 2.0
						scope:source_county = { county_checks_faith_underfed_more_frequently_trigger = yes }
					}
					trigger_event = {
						days = { 1 360 }
						on_action = do_culture_minority_underfed
					}
				}
			}
			#Otherwise, keep things as they were
			
			##### Minority Outward Effects #####
			
			### Immigration
			if = { #Immigration via development is driven by the development differential
				limit = {
					valid_immigration_source_trigger = yes
					NOT = { has_variable = recently_emmigrated }
				}
				random = {
					chance = chance_of_outward_immigration_event_per_year
					trigger_event = {
						days = { 1 360 }
						on_action = do_outward_immigration
					}
				}
			}
			
			### Faith Evangelization
			if = {
				limit = {
					faith = { is_valid_evangelizing_source_faith_trigger = yes }
					NOT = { has_variable = recently_evangelized_faith }
				}
				random = {
					chance = chance_of_faith_majority_evangelization_event_per_year
					modifier = {
						factor = 2
						faith = { is_frequently_evangelizeing_faith_trigger = yes }
					}
					modifier = {
						factor = 0.5
						faith = { infrequent_evangelization_trigger = yes }
					}
					modifier = {
						factor = 0
						faith = { never_evangelizes_trigger = yes }
					}
					trigger_event = {
						days = { 1 360 }
						on_action = do_faith_evangelization
					}
				}
			}
			
			##### Minority Growth Effects #####
			
			### Minority Growth
			if = {
				limit = {
					this.number_of_culture_minorities_in_county > 0
					NOT = { has_variable = recently_grew_minority }
				}
				random = {
					chance = chance_of_majority_growth_event_per_year
					trigger_event = {
						days = { 1 360 }
						on_action = do_culture_minority_growth
					}
				}
			}
			if = {
				limit = {
					this.number_of_faith_minorities_in_county > 0
					NOT = { has_variable = recently_grew_minority }
				}
				random = {
					chance = chance_of_majority_growth_event_per_year
					trigger_event = {
						days = { 1 360 }
						on_action = do_faith_minority_growth
					}
				}
			}
			
		}
	}
}
##### Check Culture/Faith Capacity & Feeding #####
do_culture_reduction = {
	effect = {
		demote_least_supported_minority_in_county_effect = {
			CULTURE_OR_FAITH = culture
			THE_COUNTY = scope:source_county
		}
		scope:source_county = {
			set_variable = {
				name = recently_demoted_culture
				years = years_between_over_capacity_reduction_events
			}
		}
	}
}
do_culture_minority_underfed = {
	effect = {
		demote_an_underfed_minority_in_county_effect = {
			CULTURE_OR_FAITH = culture
			THE_COUNTY = scope:source_county
		}
		scope:source_county = {
			set_variable = {
				name = recently_checked_underfed_culture
				years = years_between_general_events
			}
		}
	}
}
do_faith_reduction = {
	effect = {
		demote_least_supported_minority_in_county_effect = {
			CULTURE_OR_FAITH = faith
			THE_COUNTY = scope:source_county
		}
		scope:source_county = {
			set_variable = {
				name = recently_demoted_faith
				years = years_between_over_capacity_reduction_events
			}
		}
	}
}
do_faith_minority_underfed = {
	effect = {
		demote_an_underfed_minority_in_county_effect = {
			CULTURE_OR_FAITH = faith
			THE_COUNTY = scope:source_county
		}
		scope:source_county = {
			set_variable = {
				name = recently_checked_underfed_faith
				years = years_between_general_events
			}
		}
	}
}
##### Minority Outward Effects #####
do_outward_immigration = {
	effect = {
		outward_immigration_effect = { SOURCE_COUNTY = scope:source_county }
		scope:source_county = {
			set_variable = {
				name = recently_emmigrated
				years = years_between_general_events
			}
		}
	}
}
do_faith_evangelization = {
	effect = {
		evangelization_effect = { SOURCE_COUNTY = scope:source_county }
		scope:source_county = {
			set_variable = {
				name = recently_evangelized_faith
				years = years_between_general_events
			}
		}
	}
}
##### Minority Growth Effects #####
do_culture_minority_growth = {
	effect = {
		minority_growth_effect = {
			CULTURE_OR_FAITH = culture
			SOURCE_COUNTY = scope:source_county
		}
		scope:source_county = {
			set_variable = {
				name = recently_grew_minority
				years = years_between_general_events
			}
		}
	}
}
do_faith_minority_growth = {
	effect = {
		minority_growth_effect = {
			CULTURE_OR_FAITH = faith
			SOURCE_COUNTY = scope:source_county
		}
		scope:source_county = {
			set_variable = {
				name = recently_grew_minority
				years = years_between_general_events
			}
		}
	}
}


##### VANILLA BELOW HERE #####

# Root is a count+ character
spawn_minority_characters = {
	trigger = {
		any_sub_realm_county = {
			OR = {
				county_has_minority_culture_trigger = yes
				county_has_minority_faith_trigger = yes
			}
		}
	}
	effect = {
		every_courtier = {
			culture = { add_to_temporary_list = represented_cultures }
			faith = { add_to_temporary_list = represented_faiths }
		}

		every_sub_realm_county = {
			limit = {
				OR = {
					county_has_minority_culture_trigger = yes
					county_has_minority_faith_trigger = yes
				}
			}

			if = {
				limit = { county_has_minority_faith_trigger = yes }
				# get a random minority faith
				every_in_list = {
					variable = faith_minorities_small
					add_to_temporary_list = potential_faiths
				}
				every_in_list = {
					variable = faith_minorities_large
					add_to_temporary_list = potential_faiths
				}
				every_in_list = {
					variable = faith_minorities_large
					add_to_temporary_list = potential_faiths
				}

				random_in_list = {
					list = potential_faiths
					save_temporary_scope_as = faith_to_spawn
				}

				if = {
					limit = { county_has_minority_culture_trigger = yes }
					# randomly get a minority culture or the majority

					every_in_list = {
						variable = culture_minorities_small
						add_to_temporary_list = potential_cultures
					}
					every_in_list = {
						variable = culture_minorities_large
						add_to_temporary_list = potential_cultures
					}
					every_in_list = {
						variable = culture_minorities_large
						add_to_temporary_list = potential_cultures
					}
					culture = {
						add_to_temporary_list = potential_cultures
					}

					random_in_list = {
						list = potential_cultures
						save_temporary_scope_as = culture_to_spawn
					}
				}
				else = {
					# get the majority culture
					culture = { save_temporary_scope_as = culture_to_spawn }
				}
			}
			else_if = {
				limit = {
					county_has_minority_culture_trigger = yes
				}
				# get a random minority culture and the majority faith
				every_in_list = {
					variable = culture_minorities_small
					add_to_temporary_list = potential_cultures
				}
				every_in_list = {
					variable = culture_minorities_large
					add_to_temporary_list = potential_cultures
				}
				every_in_list = {
					variable = culture_minorities_large
					add_to_temporary_list = potential_cultures
				}

				random_in_list = {
					list = potential_cultures
					save_temporary_scope_as = culture_to_spawn
				}

				faith = { save_temporary_scope_as = faith_to_spawn }
			}

			if = {
				limit = {
					exists = scope:faith_to_spawn
					exists = scope:culture_to_spawn
					NAND = {
						scope:faith_to_spawn = { is_in_list = represented_faiths }
						scope:culture_to_spawn = { is_in_list = represented_cultures }
					}
				}

				create_character = {
					employer = root
					age = { 18 50 }
					gender_female_chance = 50
					random_traits = yes
					faith = scope:faith_to_spawn
					culture = scope:culture_to_spawn
				}

				scope:faith_to_spawn = { add_to_temporary_list = represented_faiths }
				scope:culture_to_spawn = { add_to_temporary_list = represented_cultures }
			}

			clear_variable_list = potential_cultures
			clear_variable_list = potential_faiths
			clear_saved_scope = faith_to_spawn
			clear_saved_scope = culture_to_spawn
		}
	}
}

sea_minorities_debug = {
	effect = {
		#Check culture overlap
		every_culture_global = {
			save_temporary_scope_as = the_culture
			every_county = {
				limit = {
					has_variable_list = culture_minorities_small
					has_variable_list = culture_minorities_large
					is_target_in_variable_list = { name = culture_minorities_small target = scope:the_culture }
					is_target_in_variable_list = { name = culture_minorities_large target = scope:the_culture }
				}
				save_temporary_scope_as = the_county
				every_player = {
					send_interface_message = {
						type = event_steward_task_bad
						title = minorities_debug_culture
						desc = minorities_debug_culture_desc
					}
				}
			}
		}
		#Check faith overlap
		every_religion_global = {
			every_faith = {
				save_temporary_scope_as = the_faith
				every_county = {
					limit = {
						has_variable_list = faith_minorities_small
						has_variable_list = faith_minorities_large
						is_target_in_variable_list = { name = faith_minorities_small target = scope:the_faith }
						is_target_in_variable_list = { name = faith_minorities_large target = scope:the_faith }
					}
					save_temporary_scope_as = the_county
					every_player = {
						send_interface_message = {
							type = event_steward_task_bad
							title = minorities_debug_faith
							desc = minorities_debug_faith_desc
						}
					}
				}
			}
		}
	}
}
