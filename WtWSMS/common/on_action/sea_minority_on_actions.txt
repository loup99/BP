
yearly_global_pulse = {
	on_actions = {
		on_yearly_sea_minority_maintainance
		on_yearly_sea_majority_maintainance
	}
}

three_year_playable_pulse = {
	on_actions = {
		delay = { days = { 30 330 } }
		spawn_minority_characters
	}
}

on_yearly_sea_minority_maintainance = {
	effect = {
		#### Minority Culture/Faith spread/growth/decline ####
		#=====================================================
		# Difference from "Cultural and Religious Minorities" is that we utilize quasi-cellular automata
		# rules similar to "Conway's Game of Life" to provide a marginally better model in which
		# cultures will not spread out overly far from existing concentrations of minorities.
		#
		#### How many minorities per county? ####
		#----------------------------------------
		# Every county can support minorities as a function of its development; We will utilize the Lucas
		# Sequence Vn(1,−1) [the Lucas Numbers, a series related to the Fibonacci sequence]
		#
		# 1, 3, 4, 7, 11, 18, 29, 47, 76 ...
		#
		# 01: 1 minority
		# 04: 2 minorities
		# 07: 3 minorities
		# 11: 4 minorities
		# 18: 5 minorities
		# 29: 6 minorities
		# 47: 7 minorities
		# 76: 8 minorities
		#
		# NB: Each list of culture and faith minorities will be kept separate
		#
		# We will assign a "small" minority a size of 1 and a large minority a size of 2.
		#
		# So development (urbanization) allows for greater minority presence.
		#
		#### How do minorities disappear? ####
		#-------------------------------------
		# So long as the number of minorities do not exceed the development limits, the minorities should
		# not disappear (think the various "relic" populations in various locales). Once this limit is
		# exceeded, then we need to determine which minorities are being "fed"
		#
		#### Which minority disappears first? ####
		#-----------------------------------------
		# To determine which minority disappears, we will determine which are being "fed" from
		# adjoining counties.
		# * A minority population is always "fed" if it is next to a county where it is a majority
		#   population.
		# * A minority population is fed if it has enough support.
		# * Large minorities require at least 4 points of adjoining minorities
		#    * Adjoining large minorities are worth 2
		# * Small minorities require at least 2 points of adjoining minorities
		#    * Adjoining small minorities are worth 1
		# * Any minority that is underfed is at risk of disappearing.
		#
		# NB: Certain traditions (like Diasporic) and doctrines should imply a sorting within the underfed
		# population. Diasporic Jewish populations long established themselves in Europe and Asia after
		# all.
		#
		#### How do minorities spread? ####
		#----------------------------------
		# When a county has fewer minorities than its capacity, it should randomly get a minority from an
		# adjoining county. For now, let the selection be truly random.
		every_county = {
			this = { save_scope_as = target_county }
			
			### Immigration
			if = { #If there are too few minorities, then immigration is possible
				limit = {
					county_has_minority_faith_trigger = yes
					county_has_minority_culture_trigger = yes
					this.number_of_faith_minorities_in_county_weighted <= this.minority_capacity_of_county
					this.number_of_culture_minorities_in_county_weighted <= this.minority_capacity_of_county
				}
				random = {
					chance = chance_of_minority_immigration_event_per_year
					trigger_event = {
						#days = { 1 360 }
						on_action = do_immigration
					}
				}
			}
			
			### Culture
			if = { #If there are too many minorities, some must die out
				limit = {
					county_has_minority_culture_trigger = yes
					NOT = { has_variable = recently_demoted_culture }
					this.number_of_culture_minorities_in_county_weighted > this.minority_capacity_of_county
				}
				random = {
					chance = chance_of_culture_minority_reduction_event_per_year
					trigger_event = {
						days = { 1 360 }
						on_action = do_culture_reduction
					}
				}
			}
			else_if = { #There's a chance for underfed minorities to die out
				limit = {
					county_has_minority_culture_trigger = yes
					NOT = { has_variable = recently_checked_underfed_culture }
				}
				random = {
					chance = chance_of_culture_minority_underfed_event_per_year
					trigger_event = {
						days = { 1 360 }
						on_action = do_culture_minority_underfed
					}
				}
			}
			#Otherwise, keep things as they were
			
			### Faith
			if = { #If there are too many minorities, some must die out
				limit = {
					county_has_minority_faith_trigger = yes
					NOT = { has_variable = recently_demoted_faith }
					this.number_of_faith_minorities_in_county_weighted > this.minority_capacity_of_county
				}
				random = {
					chance = chance_of_faith_minority_reduction_event_per_year
					trigger_event = {
						days = { 1 360 }
						on_action = do_faith_reduction
					}
				}
			}
			else_if = { #There's a chance for underfed minorities to die out
				limit = {
					county_has_minority_faith_trigger = yes
					NOT = { has_variable = recently_checked_underfed_faith }
				}
				random = {
					chance = chance_of_faith_minority_underfed_event_per_year
					trigger_event = {
						days = { 1 360 }
						on_action = do_culture_minority_underfed
					}
				}
			}
			#Otherwise, keep things as they were
		}
	}
}
do_immigration = {
	effect = {
		if = {
			limit = { scope:target_county = { is_valid_immigration_target_county_trigger = yes } }
			immigration_effect = yes
		}
	}
}
do_culture_reduction = {
	effect = {
		scope:target_county = {
			demote_least_supported_minority_effect = { CULTURE_OR_FAITH = culture }
			set_variable = { name = recently_demoted_culture days = 1826 } #To keep things from dropping *too* fast
		}
	}
}
do_culture_minority_underfed = {
	effect = {
		scope:target_county = {
			demote_an_underfed_minority_effect = { CULTURE_OR_FAITH = culture }
			set_variable = { name = recently_checked_underfed_culture years = 10 }
		}
	}
}
do_faith_reduction = {
	effect = {
		scope:target_county = {
			demote_least_supported_minority_effect = { CULTURE_OR_FAITH = faith }
			set_variable = { name = recently_demoted_faith days = 1826 } #To keep things from dropping *too* fast
		}
	}
}
do_faith_minority_underfed = {
	effect = {
		scope:target_county = {
			demote_an_underfed_minority_effect = { CULTURE_OR_FAITH = faith }
			set_variable = { name = recently_checked_underfed_faith years = 10 }
		}
	}
}

on_yearly_sea_majority_maintainance = {
	effect = {
		every_county = {
			this = { save_scope_as = source_county }
			
			### Faith
			if = { #If there are too many minorities, some must die out
				limit = {
					faith = { is_valid_evangelizing_source_faith_trigger = yes }
					NOT = { has_variable = recently_evangelized_faith }
				}
				random = {
					chance = chance_of_faith_majority_evangelization_event_per_year
					modifier = {
						factor = 2
						faith = { is_frequently_evangelizeing_faith_trigger = yes }
					}
					modifier = {
						factor = 0.5
						faith = { infrequent_evangelization_trigger = yes }
					}
					modifier = {
						factor = 0
						faith = { never_evangelizes_trigger = yes }
					}
					trigger_event = {
						days = { 1 360 }
						on_action = do_faith_evangelization
					}
				}
			}
		}
	}
}
do_faith_evangelization = {
	effect = {
		evangelization_effect = yes
		set_variable = { name = recently_evangelized_faith years = 10 }
	}
}

##### VANILLA BELOW HERE #####

# Root is a count+ character
spawn_minority_characters = {
	trigger = {
		any_sub_realm_county = {
			OR = {
				county_has_minority_culture_trigger = yes
				county_has_minority_faith_trigger = yes
			}
		}
	}
	effect = {
		every_courtier = {
			culture = { add_to_temporary_list = represented_cultures }
			faith = { add_to_temporary_list = represented_faiths }
		}

		every_sub_realm_county = {
			limit = {
				OR = {
					county_has_minority_culture_trigger = yes
					county_has_minority_faith_trigger = yes
				}
			}

			if = {
				limit = { county_has_minority_faith_trigger = yes }
				# get a random minority faith
				every_in_list = {
					variable = faith_minorities_small
					add_to_temporary_list = potential_faiths
				}
				every_in_list = {
					variable = faith_minorities_large
					add_to_temporary_list = potential_faiths
				}
				every_in_list = {
					variable = faith_minorities_large
					add_to_temporary_list = potential_faiths
				}

				random_in_list = {
					list = potential_faiths
					save_temporary_scope_as = faith_to_spawn
				}

				if = {
					limit = { county_has_minority_culture_trigger = yes }
					# randomly get a minority culture or the majority

					every_in_list = {
						variable = culture_minorities_small
						add_to_temporary_list = potential_cultures
					}
					every_in_list = {
						variable = culture_minorities_large
						add_to_temporary_list = potential_cultures
					}
					every_in_list = {
						variable = culture_minorities_large
						add_to_temporary_list = potential_cultures
					}
					culture = {
						add_to_temporary_list = potential_cultures
					}

					random_in_list = {
						list = potential_cultures
						save_temporary_scope_as = culture_to_spawn
					}
				}
				else = {
					# get the majority culture
					culture = { save_temporary_scope_as = culture_to_spawn }
				}
			}
			else_if = {
				limit = {
					county_has_minority_culture_trigger = yes
				}
				# get a random minority culture and the majority faith
				every_in_list = {
					variable = culture_minorities_small
					add_to_temporary_list = potential_cultures
				}
				every_in_list = {
					variable = culture_minorities_large
					add_to_temporary_list = potential_cultures
				}
				every_in_list = {
					variable = culture_minorities_large
					add_to_temporary_list = potential_cultures
				}

				random_in_list = {
					list = potential_cultures
					save_temporary_scope_as = culture_to_spawn
				}

				faith = { save_temporary_scope_as = faith_to_spawn }
			}

			if = {
				limit = {
					exists = scope:faith_to_spawn
					exists = scope:culture_to_spawn
					NAND = {
						scope:faith_to_spawn = { is_in_list = represented_faiths }
						scope:culture_to_spawn = { is_in_list = represented_cultures }
					}
				}

				create_character = {
					employer = root
					age = { 18 50 }
					gender_female_chance = 50
					random_traits = yes
					faith = scope:faith_to_spawn
					culture = scope:culture_to_spawn
				}

				scope:faith_to_spawn = { add_to_temporary_list = represented_faiths }
				scope:culture_to_spawn = { add_to_temporary_list = represented_cultures }
			}

			clear_variable_list = potential_cultures
			clear_variable_list = potential_faiths
			clear_saved_scope = faith_to_spawn
			clear_saved_scope = culture_to_spawn
		}
	}
}